<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M-Pesa Financial Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Firebase SDK Compat -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --green: #00AA4F;
            --green-dark: #006B3D;
            --green-light: #d1fae5;
            --text: #1a2332;
            --muted: #6b7280;
            --border: #e5e7eb;
            --bg: #f4f6f9;
            --white: #ffffff;
            --shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* ===== NAVBAR ===== */
        .navbar {
            background: linear-gradient(135deg, var(--green) 0%, var(--green-dark) 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .navbar-content {
            max-width: 1300px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.3rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            letter-spacing: -0.3px;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            opacity: 0.85;
            transition: opacity 0.2s;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .nav-link:hover {
            opacity: 1;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        /* ===== FLOW INDICATOR ===== */
        .flow-bar {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 2rem;
            display: none;
        }

        .flow-bar.visible {
            display: block;
        }

        .flow-steps {
            max-width: 1300px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 0;
        }

        .flow-step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--muted);
            flex: 1;
            position: relative;
        }

        .flow-step::after {
            content: '→';
            position: absolute;
            right: -4px;
            color: var(--border);
            font-size: 1rem;
        }

        .flow-step:last-child::after {
            display: none;
        }

        .flow-step.active {
            color: var(--green);
        }

        .flow-step.done {
            color: #27ae60;
        }

        .flow-dot {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--border);
            color: var(--muted);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            flex-shrink: 0;
        }

        .flow-step.active .flow-dot {
            background: var(--green);
            color: white;
        }

        .flow-step.done .flow-dot {
            background: #27ae60;
            color: white;
        }

        /* ===== CONTAINER ===== */
        .container {
            max-width: 1300px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        /* ===== SCREENS ===== */
        .screen {
            display: none;
            animation: fadeUp 0.35s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(16px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== BUTTONS ===== */
        .btn {
            padding: 0.875rem 2rem;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.25s;
            font-family: 'Plus Jakarta Sans', sans-serif;
            letter-spacing: 0.2px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--green), var(--green-dark));
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 170, 79, 0.35);
        }

        .btn-primary:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: var(--text);
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-lg {
            font-size: 1.1rem;
            padding: 1.1rem 2.75rem;
        }

        .btn-sm {
            padding: 0.45rem 1.1rem;
            font-size: 0.82rem;
        }

        .btn-full {
            width: 100%;
        }

        /* ===== CARDS ===== */
        .card {
            background: white;
            border-radius: 18px;
            padding: 2.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 0.4rem;
        }

        .card-subtitle {
            color: var(--muted);
            margin-bottom: 2rem;
            font-size: 0.97rem;
        }

        /* ===== ALERTS ===== */
        .alert {
            padding: 1rem 1.25rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            font-size: 0.9rem;
        }

        .alert-info {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            color: #1d4ed8;
        }

        .alert-success {
            background: #f0fdf4;
            border-left: 4px solid var(--green);
            color: #166534;
        }

        /* ============================================================
           SCREEN 0 — LANDING PAGE
        ============================================================ */
        .landing-wrap {
            max-width: 1200px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }

        .hero {
            background: linear-gradient(135deg, var(--green) 0%, var(--green-dark) 100%);
            border-radius: 24px;
            padding: 4rem 3rem;
            color: white;
            text-align: center;
            margin-bottom: 3.5rem;
            box-shadow: 0 12px 40px rgba(0, 170, 79, 0.3);
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: -60px;
            right: -60px;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.07);
            pointer-events: none;
        }

        .hero::after {
            content: '';
            position: absolute;
            bottom: -80px;
            left: -40px;
            width: 250px;
            height: 250px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            pointer-events: none;
        }

        .hero-title {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 1rem;
            letter-spacing: -1px;
            position: relative;
            z-index: 1;
        }

        .hero-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 2rem;
            position: relative;
            z-index: 1;
        }

        .hero-cta {
            position: relative;
            z-index: 1;
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-hero {
            background: white;
            color: var(--green-dark);
            font-size: 1.1rem;
            padding: 1rem 2.5rem;
            border-radius: 12px;
            border: none;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.25s;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .btn-hero:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .btn-hero-ghost {
            background: transparent;
            color: white;
            font-size: 1rem;
            padding: 1rem 2.5rem;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.25s;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .btn-hero-ghost:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: white;
        }

        /* ===== LANDING VIDEO ===== */
        .landing-video-section {
            margin-bottom: 3.5rem;
        }

        .section-label {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--green);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 0.5rem;
        }

        .section-heading {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 0.5rem;
            letter-spacing: -0.5px;
        }

        .section-sub {
            color: var(--muted);
            margin-bottom: 2rem;
            font-size: 1rem;
        }

        .video-shell {
            background: linear-gradient(135deg, #0d1f35 0%, #0a1628 100%);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.25);
            position: relative;
        }

        .video-inner {
            display: grid;
            grid-template-columns: 1fr 320px;
            min-height: 380px;
        }

        .video-player-wrap {
            position: relative;
            background: #000;
            overflow: hidden;
        }

        .video-canvas-el {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: cover;
        }

        .vid-overlay-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.85));
            padding: 2rem 1.5rem 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .vid-progress-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .play-pause-btn {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: none;
            background: var(--green);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .play-pause-btn:hover {
            background: #27ae60;
            transform: scale(1.1);
        }

        .vid-progress-bar {
            flex: 1;
            height: 5px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }

        .vid-progress-fill {
            height: 100%;
            background: var(--green);
            border-radius: 3px;
            transition: width 0.1s linear;
            width: 0%;
        }

        .vid-time {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            font-family: 'JetBrains Mono', monospace;
            white-space: nowrap;
        }

        .video-sidebar {
            padding: 2rem 1.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            border-left: 1px solid rgba(255, 255, 255, 0.07);
        }

        .video-sidebar-title {
            font-size: 1rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
        }

        .video-sidebar-desc {
            font-size: 0.82rem;
            color: rgba(255, 255, 255, 0.55);
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .chapter-list {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .chapter-btn {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.6rem 0.85rem;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.04);
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .chapter-btn:hover {
            background: rgba(0, 170, 79, 0.15);
            border-color: rgba(0, 170, 79, 0.3);
        }

        .chapter-btn.active {
            background: rgba(0, 170, 79, 0.2);
            border-color: rgba(0, 170, 79, 0.4);
        }

        .ch-num {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.7rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .chapter-btn.active .ch-num {
            background: var(--green);
            color: white;
        }

        .ch-info {
            flex: 1;
        }

        .ch-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 600;
        }

        .ch-time {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.4);
            font-family: 'JetBrains Mono', monospace;
        }

        /* ===== STEPS GRID ===== */
        .steps-section {
            margin-bottom: 3.5rem;
        }

        .steps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
        }

        .step-card {
            background: white;
            border-radius: 16px;
            padding: 2rem 1.5rem;
            text-align: center;
            box-shadow: var(--shadow);
            position: relative;
            transition: transform 0.25s, box-shadow 0.25s;
            border: 2px solid transparent;
        }

        .step-card:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-lg);
            border-color: var(--green-light);
        }

        .step-num {
            position: absolute;
            top: -12px;
            right: -12px;
            width: 32px;
            height: 32px;
            background: var(--green);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(0, 170, 79, 0.3);
        }

        .step-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .step-card h3 {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .step-card p {
            color: var(--muted);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* ===== FEATURES ===== */
        .features-section {
            margin-bottom: 3.5rem;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
            gap: 1.25rem;
        }

        .feature-card {
            background: white;
            border-radius: 14px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .feature-icon {
            font-size: 2.5rem;
            display: block;
            margin-bottom: 0.75rem;
        }

        .feature-card h4 {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 0.3rem;
        }

        .feature-card p {
            color: var(--muted);
            font-size: 0.85rem;
        }

        /* ===== CTA STRIP ===== */
        .cta-strip {
            background: white;
            border-radius: 18px;
            padding: 2.5rem;
            text-align: center;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .cta-strip h2 {
            font-size: 1.75rem;
            font-weight: 800;
            margin-bottom: 1.5rem;
            letter-spacing: -0.3px;
        }

        /* ============================================================
           SCREEN 1 — PDF UPLOAD
        ============================================================ */
        .upload-wrap {
            max-width: 680px;
            margin: 3rem auto;
        }

        .upload-area {
            border: 3px dashed var(--border);
            border-radius: 14px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s;
            background: #fafafa;
            margin-bottom: 1.5rem;
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: var(--green);
            background: #f0fdf4;
        }

        .upload-icon {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            display: block;
        }

        .upload-text {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.4rem;
        }

        .upload-hint {
            font-size: 0.85rem;
            color: var(--muted);
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 0.85rem 1rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 0.95rem;
            font-family: 'Plus Jakarta Sans', sans-serif;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--green);
        }

        /* ============================================================
           SCREEN 2 — SMART MONEY RULES (new dedicated page)
        ============================================================ */
        .rules-wrap {
            max-width: 900px;
            margin: 3rem auto;
        }

        .rules-page-header {
            background: linear-gradient(135deg, var(--green) 0%, var(--green-dark) 100%);
            border-radius: 18px;
            padding: 2rem 2.5rem;
            color: white;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .rules-page-icon {
            font-size: 3rem;
            flex-shrink: 0;
        }

        .rules-page-header h1 {
            font-size: 1.6rem;
            font-weight: 800;
            margin-bottom: 0.3rem;
        }

        .rules-page-header p {
            opacity: 0.85;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .rules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .rule-card {
            background: white;
            border: 2px solid var(--green-light);
            border-radius: 16px;
            padding: 1.75rem;
            transition: all 0.2s;
        }

        .rule-card:hover {
            border-color: var(--green);
            box-shadow: 0 4px 16px rgba(0, 170, 79, 0.12);
            transform: translateY(-2px);
        }

        .rule-card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }

        .rule-pill {
            background: linear-gradient(135deg, var(--green), var(--green-dark));
            color: white;
            padding: 0.2rem 0.7rem;
            border-radius: 20px;
            font-size: 0.72rem;
            font-weight: 800;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .rule-card-title {
            font-weight: 700;
            color: var(--text);
            font-size: 0.95rem;
        }

        .field-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .field-group label {
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--muted);
            margin-bottom: 0.35rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .field-group input,
        .field-group select {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.88rem;
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: white;
            transition: border-color 0.2s;
        }

        .field-group input:focus,
        .field-group select:focus {
            outline: none;
            border-color: var(--green);
        }

        .rule-arrow {
            font-size: 0.8rem;
            color: var(--muted);
            font-style: italic;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px dashed #d1fae5;
            line-height: 1.4;
        }

        .rules-preview {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border-radius: 14px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #bbf7d0;
        }

        .rules-preview h3 {
            font-size: 0.95rem;
            font-weight: 700;
            color: #166534;
            margin-bottom: 1rem;
        }

        .preview-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .preview-stat {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
        }

        .preview-stat-value {
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--green);
            font-family: 'JetBrains Mono', monospace;
        }

        .preview-stat-label {
            font-size: 0.75rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-top: 0.2rem;
        }

        .rules-actions {
            display: flex;
            gap: 1rem;
        }

        /* ============================================================
           SCREEN 3 — PROCESSING
        ============================================================ */
        .processing-wrap {
            max-width: 800px;
            margin: 3rem auto;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2.5rem;
            position: relative;
        }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 22px;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--border);
            z-index: 0;
        }

        .p-step {
            position: relative;
            text-align: center;
            flex: 1;
            z-index: 1;
        }

        .p-circle {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: white;
            border: 4px solid var(--border);
            margin: 0 auto 0.6rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: var(--muted);
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .p-step.active .p-circle {
            background: var(--green);
            border-color: var(--green);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 170, 79, 0.3);
        }

        .p-step.done .p-circle {
            background: var(--green);
            border-color: var(--green);
            color: white;
        }

        .p-label {
            font-size: 0.78rem;
            font-weight: 600;
            color: var(--muted);
        }

        .p-step.active .p-label {
            color: var(--green);
            font-weight: 700;
        }

        .p-step.done .p-label {
            color: #27ae60;
        }

        .prog-bar {
            width: 100%;
            height: 10px;
            background: var(--border);
            border-radius: 5px;
            overflow: hidden;
            margin: 1.5rem 0;
        }

        .prog-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--green), #27ae60);
            transition: width 0.5s ease;
            border-radius: 5px;
        }

        .prog-text {
            text-align: center;
            color: var(--muted);
            font-size: 0.95rem;
            margin-top: 0.75rem;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.25rem;
            margin-top: 2rem;
        }

        .stat-box {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
        }

        .stat-val {
            font-size: 2rem;
            font-weight: 800;
            color: var(--green);
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-lab {
            font-size: 0.75rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.25rem;
            font-weight: 600;
        }

        /* ============================================================
           SCREEN 4 — MERCHANT LEARNER
        ============================================================ */
        .learn-wrap {
            max-width: 780px;
            margin: 3rem auto;
        }

        .merchant-card {
            background: white;
            border: 2px solid var(--border);
            border-radius: 14px;
            padding: 1.75rem;
            margin-bottom: 1.5rem;
            animation: fadeUp 0.3s ease;
        }

        .merchant-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.35rem;
        }

        .merchant-meta {
            color: var(--muted);
            font-size: 0.88rem;
            margin-bottom: 1rem;
        }

        .amounts-box {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: 12px;
            padding: 1.25rem;
            border-left: 4px solid #3b82f6;
            margin-bottom: 1.5rem;
        }

        .amounts-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .amount-cell {
            background: white;
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
        }

        .amount-cell-label {
            font-size: 0.7rem;
            color: var(--muted);
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.3px;
            margin-bottom: 0.2rem;
        }

        .amount-cell-value {
            font-size: 1rem;
            font-weight: 800;
            color: var(--green);
            font-family: 'JetBrains Mono', monospace;
        }

        .amount-range {
            font-size: 0.8rem;
            color: #64748b;
            text-align: center;
            border-top: 1px solid #cbd5e1;
            padding-top: 0.5rem;
        }

        .cat-label {
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }

        .cat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .cat-btn {
            padding: 0.85rem 0.5rem;
            background: #f8f9fa;
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            font-size: 0.88rem;
            font-weight: 600;
            font-family: 'Plus Jakarta Sans', sans-serif;
            transition: all 0.2s;
        }

        .cat-btn:hover {
            border-color: var(--green);
            background: #f0fdf4;
            transform: translateY(-2px);
        }

        .cat-btn.selected {
            background: var(--green);
            border-color: var(--green);
            color: white;
        }

        .learn-actions {
            display: flex;
            gap: 0.75rem;
        }

        .learn-actions .btn {
            flex: 1;
        }

        /* ============================================================
           SCREEN 5 — DASHBOARD
        ============================================================ */
        .dash-wrap {
            padding: 2rem 0;
        }

        .dash-header {
            background: white;
            border-radius: 18px;
            padding: 1.75rem 2rem;
            margin-bottom: 1.75rem;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .dash-title {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--text);
            letter-spacing: -0.4px;
        }

        .dash-sub {
            color: var(--muted);
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .dash-date {
            font-size: 0.82rem;
            background: var(--green-light);
            color: var(--green-dark);
            padding: 0.4rem 0.9rem;
            border-radius: 20px;
            font-weight: 700;
        }

        .summary-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.25rem;
            margin-bottom: 1.75rem;
        }

        .sum-card {
            background: white;
            border-radius: 14px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: transform 0.2s;
            border-top: 4px solid var(--border);
        }

        .sum-card:nth-child(1) {
            border-top-color: #e74c3c;
        }

        .sum-card:nth-child(2) {
            border-top-color: var(--green);
        }

        .sum-card:nth-child(3) {
            border-top-color: #3b82f6;
        }

        .sum-card:nth-child(4) {
            border-top-color: #f39c12;
        }

        .sum-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .sum-label {
            font-size: 0.78rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .sum-value {
            font-size: 1.9rem;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 0.25rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .sum-note {
            font-size: 0.82rem;
            color: var(--muted);
        }

        .sum-note.pos {
            color: #27ae60;
        }

        /* ===== TABS ===== */
        .tabs-wrap {
            background: white;
            border-radius: 18px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .tabs-nav {
            display: flex;
            gap: 0;
            border-bottom: 2px solid var(--border);
            overflow-x: auto;
        }

        .tab-btn {
            padding: 1.1rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 0.88rem;
            font-weight: 700;
            color: var(--muted);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .tab-btn:hover {
            color: var(--text);
        }

        .tab-btn.active {
            color: var(--green);
            border-bottom-color: var(--green);
        }

        .tab-panel {
            display: none;
            padding: 2rem;
        }

        .tab-panel.active {
            display: block;
        }

        .panel-title {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        /* ===== RECOMMENDATIONS ===== */
        .rec-item {
            border-left: 5px solid var(--green);
            background: #f8fffe;
            padding: 1.5rem;
            margin-bottom: 1.25rem;
            border-radius: 10px;
            transition: all 0.2s;
        }

        .rec-item:hover {
            background: #f0fdf4;
            transform: translateX(4px);
        }

        .rec-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
            gap: 1rem;
        }

        .rec-title {
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--text);
            flex: 1;
        }

        .badge {
            padding: 0.3rem 0.75rem;
            border-radius: 20px;
            font-size: 0.72rem;
            font-weight: 800;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .badge-crit {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-hi {
            background: #fef3c7;
            color: #92400e;
        }

        .rec-detail {
            font-size: 0.88rem;
            color: #4b5563;
            margin-bottom: 0.75rem;
            line-height: 1.6;
        }

        .rec-impact {
            font-size: 0.95rem;
            color: #27ae60;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .rec-btns {
            display: flex;
            gap: 0.6rem;
            flex-wrap: wrap;
        }

        /* ===== INSIGHTS ===== */
        .insight-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1.1rem 1.25rem;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #3b82f6;
            margin-bottom: 1rem;
        }

        .insight-icon {
            font-size: 1.4rem;
            flex-shrink: 0;
        }

        /* ===== ANALYTICS CHARTS ===== */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
            gap: 1.5rem;
        }

        .chart-box {
            background: #f8f9fa;
            border-radius: 14px;
            padding: 1.5rem;
        }

        .chart-box h3 {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text);
        }

        canvas {
            max-height: 280px;
        }

        /* ===== SMART RULES ON DASHBOARD ===== */
        .dash-rules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .dash-rule-card {
            background: linear-gradient(135deg, #f8fffe 0%, #f0fdf4 100%);
            border: 2px solid #bbf7d0;
            border-radius: 14px;
            padding: 1.5rem;
            transition: all 0.2s;
        }

        .dash-rule-card:hover {
            border-color: var(--green);
            box-shadow: 0 4px 12px rgba(0, 170, 79, 0.12);
            transform: translateY(-2px);
        }

        /* ===== DIRECTORY PAGE ===== */
        .dir-header {
            background: linear-gradient(135deg, var(--green), var(--green-dark));
            border-radius: 16px;
            padding: 1.75rem 2rem;
            color: white;
            margin-bottom: 1.75rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.18);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem 1.1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 700;
            font-family: 'Plus Jakarta Sans', sans-serif;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.28);
        }

        .dir-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(270px, 1fr));
            gap: 1.25rem;
        }

        .dir-card {
            background: white;
            border-radius: 16px;
            padding: 1.75rem;
            box-shadow: var(--shadow);
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.25s;
        }

        .dir-card:hover {
            border-color: var(--green);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 170, 79, 0.15);
        }

        .dir-card.featured {
            border-color: var(--green);
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
        }

        .dir-icon-wrap {
            width: 52px;
            height: 52px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            margin-bottom: 1.1rem;
        }

        .ic-green {
            background: #d1fae5;
        }

        .ic-blue {
            background: #dbeafe;
        }

        .ic-yellow {
            background: #fef3c7;
        }

        .ic-purple {
            background: #ede9fe;
        }

        .ic-red {
            background: #fee2e2;
        }

        .ic-teal {
            background: #ccfbf1;
        }

        .dir-card-title {
            font-size: 1rem;
            font-weight: 800;
            margin-bottom: 0.4rem;
        }

        .dir-card-desc {
            font-size: 0.85rem;
            color: var(--muted);
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .dir-tag {
            display: inline-block;
            padding: 0.2rem 0.7rem;
            border-radius: 20px;
            font-size: 0.72rem;
            font-weight: 700;
            background: #f3f4f6;
            color: #374151;
        }

        .tag-new {
            background: #d1fae5;
            color: #065f46;
        }

        .tag-hot {
            background: #fef3c7;
            color: #92400e;
        }

        .tag-crit {
            background: #fee2e2;
            color: #991b1b;
        }

        /* ===== TOAST ===== */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--green-dark);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            font-weight: 700;
            z-index: 9999;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
            animation: fadeUp 0.3s ease;
            font-size: 0.9rem;
        }

        /* ===== PERIOD FILTER BAR ===== */
        .period-filter-bar {
            background: white;
            border-radius: 16px;
            padding: 1.25rem 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            border: 2px solid var(--green-light);
        }

        .period-bar-inner {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .period-presets {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .period-label {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .period-chip {
            padding: 0.4rem 0.9rem;
            border-radius: 20px;
            border: 2px solid var(--border);
            background: #f8f9fa;
            color: var(--text);
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Plus Jakarta Sans', sans-serif;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .period-chip:hover {
            border-color: var(--green);
            color: var(--green);
            background: #f0fdf4;
        }

        .period-chip.active {
            background: var(--green);
            border-color: var(--green);
            color: white;
        }

        .period-custom {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            flex-wrap: wrap;
            margin-left: auto;
        }

        .period-custom-fields {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .period-custom-fields select {
            padding: 0.4rem 0.7rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.82rem;
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: 600;
            color: var(--text);
            background: white;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .period-custom-fields select:focus {
            outline: none;
            border-color: var(--green);
        }

        .period-range-btn {
            padding: 0.4rem 0.9rem;
            border-radius: 8px;
            border: 2px solid var(--border);
            background: white;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Plus Jakarta Sans', sans-serif;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .period-range-btn:hover {
            border-color: var(--green);
            color: var(--green);
        }

        .period-range-btn.open {
            border-color: var(--green);
            background: #f0fdf4;
            color: var(--green-dark);
        }

        .range-picker {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .range-fields {
            display: flex;
            align-items: flex-end;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .range-field label {
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.4px;
            margin-bottom: 0.35rem;
        }

        .range-field input[type="date"] {
            padding: 0.5rem 0.75rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.88rem;
            font-family: 'Plus Jakarta Sans', sans-serif;
            transition: border-color 0.2s;
        }

        .range-field input[type="date"]:focus {
            outline: none;
            border-color: var(--green);
        }

        .range-sep {
            font-size: 1.2rem;
            color: var(--muted);
            font-weight: 700;
            padding-bottom: 0.35rem;
        }

        .active-filter {
            margin-top: 0.75rem;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border-radius: 8px;
            border: 1px solid #bbf7d0;
            font-size: 0.82rem;
            font-weight: 700;
            color: var(--green-dark);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* ===== DETAIL PAGE ===== */
        .detail-wrap {
            padding: 2rem 0;
        }

        .detail-hero {
            border-radius: 20px;
            padding: 2.5rem;
            color: white;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .detail-hero::after {
            content: '';
            position: absolute;
            top: -60px;
            right: -60px;
            width: 260px;
            height: 260px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.07);
            pointer-events: none;
        }

        .detail-hero-top {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.25rem;
            position: relative;
            z-index: 1;
        }

        .detail-back-btn {
            background: rgba(255, 255, 255, 0.18);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.45rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.82rem;
            font-weight: 700;
            font-family: 'Plus Jakarta Sans', sans-serif;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .detail-back-btn:hover {
            background: rgba(255, 255, 255, 0.28);
        }

        .detail-hero-icon {
            width: 64px;
            height: 64px;
            border-radius: 18px;
            background: rgba(255, 255, 255, 0.18);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            flex-shrink: 0;
        }

        .detail-hero-text {
            flex: 1;
            position: relative;
            z-index: 1;
        }

        .detail-tag-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }

        .detail-tag {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.2rem 0.7rem;
            border-radius: 20px;
            font-size: 0.72rem;
            font-weight: 700;
            letter-spacing: 0.4px;
        }

        .detail-hero h1 {
            font-size: 1.75rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            letter-spacing: -0.3px;
        }

        .detail-hero-sub {
            font-size: 1rem;
            opacity: 0.88;
            line-height: 1.5;
        }

        .detail-stat-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .detail-stat {
            background: white;
            border-radius: 14px;
            padding: 1.25rem;
            text-align: center;
            box-shadow: var(--shadow);
            border-top: 4px solid var(--green);
        }

        .detail-stat-val {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--green);
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 0.25rem;
        }

        .detail-stat-label {
            font-size: 0.75rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
        }

        .detail-body {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 1.5rem;
            align-items: start;
        }

        .detail-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
        }

        .detail-section h2 {
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .how-steps {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .how-step {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border);
            position: relative;
        }

        .how-step:last-child {
            border-bottom: none;
        }

        .how-step-num {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--green), var(--green-dark));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .how-step-content h4 {
            font-size: 0.95rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .how-step-content p {
            font-size: 0.87rem;
            color: var(--muted);
            line-height: 1.5;
        }

        .benefit-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .benefit-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.875rem 1rem;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 3px solid var(--green);
        }

        .benefit-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
            margin-top: 0.1rem;
        }

        .benefit-item h4 {
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 0.2rem;
        }

        .benefit-item p {
            font-size: 0.82rem;
            color: var(--muted);
            line-height: 1.4;
        }

        .faq-list {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .faq-item {
            border-bottom: 1px solid var(--border);
            padding: 1rem 0;
            cursor: pointer;
        }

        .faq-item:last-child {
            border-bottom: none;
        }

        .faq-q {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            user-select: none;
        }

        .faq-arrow {
            font-size: 0.8rem;
            color: var(--muted);
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        .faq-item.open .faq-arrow {
            transform: rotate(180deg);
        }

        .faq-a {
            font-size: 0.85rem;
            color: var(--muted);
            line-height: 1.6;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.2s;
        }

        .faq-item.open .faq-a {
            max-height: 200px;
            padding-top: 0.6rem;
        }

        .detail-sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .sidebar-cta {
            background: linear-gradient(135deg, var(--green), var(--green-dark));
            border-radius: 16px;
            padding: 1.75rem;
            color: white;
            text-align: center;
        }

        .sidebar-cta h3 {
            font-size: 1.1rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .sidebar-cta p {
            font-size: 0.85rem;
            opacity: 0.88;
            margin-bottom: 1.25rem;
            line-height: 1.5;
        }

        .sidebar-cta-btn {
            width: 100%;
            background: white;
            color: var(--green-dark);
            border: none;
            padding: 0.875rem;
            border-radius: 10px;
            font-weight: 800;
            font-size: 0.95rem;
            cursor: pointer;
            font-family: 'Plus Jakarta Sans', sans-serif;
            transition: all 0.2s;
            margin-bottom: 0.6rem;
        }

        .sidebar-cta-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .sidebar-cta-secondary {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .sidebar-cta-secondary:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .sidebar-related {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }

        .sidebar-related h3 {
            font-size: 0.9rem;
            font-weight: 800;
            margin-bottom: 1rem;
            color: var(--text);
        }

        .related-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .related-item:last-child {
            border-bottom: none;
        }

        .related-item:hover {
            padding-left: 0.5rem;
        }

        .related-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .related-title {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text);
        }

        .related-desc {
            font-size: 0.75rem;
            color: var(--muted);
        }

        .related-arrow {
            margin-left: auto;
            color: var(--muted);
            font-size: 0.8rem;
        }

        .savings-bar-wrap {
            margin-top: 1rem;
        }

        .savings-bar-item {
            margin-bottom: 1rem;
        }

        .savings-bar-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.82rem;
            font-weight: 700;
            margin-bottom: 0.35rem;
        }

        .savings-bar-track {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .savings-bar-fill {
            height: 100%;
            border-radius: 4px;
            background: linear-gradient(90deg, var(--green), #27ae60);
            transition: width 1s ease;
        }

        @media (max-width: 900px) {
            .detail-body {
                grid-template-columns: 1fr;
            }

            .detail-sidebar {
                order: -1;
            }
        }

        @media (max-width: 768px) {
            .detail-hero {
                padding: 1.75rem 1.25rem;
            }

            .detail-hero h1 {
                font-size: 1.35rem;
            }
        }

        /* ===== RESPONSIVE ADDITIONS ===== */
        @media (max-width: 768px) {
            .period-bar-inner {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .period-custom {
                margin-left: 0;
            }
        }

        @media (max-width: 900px) {
            .video-inner {
                grid-template-columns: 1fr;
            }

            .video-sidebar {
                border-left: none;
                border-top: 1px solid rgba(255, 255, 255, 0.07);
            }
        }

        @media (max-width: 768px) {

            .container,
            .landing-wrap {
                padding: 0 1rem;
            }

            .hero-title {
                font-size: 2rem;
            }

            .hero-subtitle {
                font-size: 1rem;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .amounts-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .field-row {
                grid-template-columns: 1fr;
            }

            .rules-actions {
                flex-direction: column;
            }

            .stats-row {
                grid-template-columns: 1fr;
            }
        }

        /* ===== AUTHENTICATION SCREENS ===== */
        .auth-container {
            max-width: 1100px;
            margin: 3rem auto;
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 3rem;
            align-items: start;
        }

        .auth-card {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            box-shadow: var(--shadow-lg);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .auth-logo {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--green), var(--green-dark));
            color: white;
            font-size: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
        }

        .auth-title {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 0.5rem;
            letter-spacing: -0.5px;
        }

        .auth-subtitle {
            color: var(--muted);
            font-size: 0.95rem;
        }

        .auth-form {
            margin-bottom: 2rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-hint {
            display: block;
            font-size: 0.8rem;
            color: var(--muted);
            margin-top: 0.35rem;
        }

        .form-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .form-checkbox input[type="checkbox"] {
            margin-top: 0.2rem;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .form-checkbox label {
            font-size: 0.88rem;
            color: var(--text);
            line-height: 1.5;
        }

        .form-checkbox a {
            color: var(--green);
            text-decoration: none;
            font-weight: 600;
        }

        .form-checkbox a:hover {
            text-decoration: underline;
        }

        .password-strength {
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin-top: 0.5rem;
            overflow: hidden;
            position: relative;
        }

        .password-strength::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0%;
            transition: width 0.3s, background 0.3s;
        }

        .password-strength.weak::after {
            width: 33%;
            background: #e74c3c;
        }

        .password-strength.medium::after {
            width: 66%;
            background: #f39c12;
        }

        .password-strength.strong::after {
            width: 100%;
            background: #27ae60;
        }

        .forgot-link {
            float: right;
            font-size: 0.85rem;
            color: var(--green);
            text-decoration: none;
            font-weight: 600;
        }

        .forgot-link:hover {
            text-decoration: underline;
        }

        .auth-divider {
            text-align: center;
            margin: 2rem 0;
            position: relative;
        }

        .auth-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--border);
        }

        .auth-divider span {
            background: white;
            padding: 0 1rem;
            position: relative;
            color: var(--muted);
            font-size: 0.85rem;
        }

        .auth-social {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .btn-social {
            padding: 0.875rem 1rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            transition: all 0.2s;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .btn-social:hover {
            border-color: var(--green);
            background: #f0fdf4;
        }

        .auth-footer {
            text-align: center;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
            color: var(--muted);
            font-size: 0.9rem;
        }

        .auth-footer a {
            color: var(--green);
            text-decoration: none;
            font-weight: 700;
        }

        .auth-footer a:hover {
            text-decoration: underline;
        }

        /* Auth sidebar content */
        .auth-benefits {
            background: linear-gradient(135deg, var(--green), var(--green-dark));
            border-radius: 20px;
            padding: 2.5rem;
            color: white;
            position: sticky;
            top: 2rem;
        }

        .auth-benefits h3 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            font-weight: 800;
        }

        .benefits-list {
            list-style: none;
        }

        .benefits-list li {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .check-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .auth-stats {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .stat-pill {
            background: white;
            border-radius: 16px;
            padding: 1.75rem 2rem;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .stat-pill-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--green);
            margin-bottom: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-pill-label {
            font-size: 0.85rem;
            color: var(--muted);
            font-weight: 600;
        }

        /* ===== HELP CENTER ===== */
        .help-wrap {
            padding: 2rem 0;
            max-width: 1200px;
            margin: 0 auto;
        }

        .help-header {
            background: linear-gradient(135deg, var(--green), var(--green-dark));
            border-radius: 20px;
            padding: 3rem;
            color: white;
            margin-bottom: 2.5rem;
        }

        .help-header-content {
            margin-bottom: 2rem;
        }

        .help-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            letter-spacing: -0.5px;
        }

        .help-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .help-search {
            position: relative;
            max-width: 600px;
        }

        .help-search-input {
            width: 100%;
            padding: 1rem 1.25rem 1rem 3.5rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        .help-search-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .help-search-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .help-search-icon {
            position: absolute;
            left: 1.25rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.25rem;
        }

        .help-quick-links {
            margin-bottom: 3rem;
        }

        .help-quick-links h3 {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--text);
        }

        .quick-links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.25rem;
        }

        .quick-link-card {
            background: white;
            border-radius: 14px;
            padding: 1.75rem 1.5rem;
            text-align: center;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: block;
        }

        .quick-link-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border: 2px solid var(--green-light);
        }

        .ql-icon {
            font-size: 2.5rem;
            display: block;
            margin-bottom: 0.75rem;
        }

        .ql-title {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text);
        }

        .help-content {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            box-shadow: var(--shadow);
        }

        .help-section {
            margin-bottom: 4rem;
            scroll-margin-top: 100px;
        }

        .help-section:last-child {
            margin-bottom: 0;
        }

        .help-section-title {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text);
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid var(--green-light);
        }

        .help-article {
            margin-bottom: 2.5rem;
        }

        .help-article:last-child {
            margin-bottom: 0;
        }

        .help-article h3 {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 1rem;
        }

        .help-article p {
            color: #4b5563;
            line-height: 1.8;
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }

        .help-article ul,
        .help-article ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .help-article li {
            color: #4b5563;
            line-height: 1.8;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .help-article code {
            background: #f3f4f6;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.88rem;
            color: var(--green-dark);
        }

        .help-steps {
            counter-reset: step-counter;
            list-style: none;
            margin-left: 0;
        }

        .help-steps li {
            counter-increment: step-counter;
            position: relative;
            padding-left: 3rem;
            margin-bottom: 1.5rem;
        }

        .help-steps li::before {
            content: counter(step-counter);
            position: absolute;
            left: 0;
            top: 0;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--green);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.9rem;
        }

        .help-note {
            padding: 1.25rem 1.5rem;
            border-radius: 12px;
            margin: 1.5rem 0;
            border-left: 4px solid;
        }

        .help-note-warning {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
        }

        .help-note-info {
            background: #dbeafe;
            border-color: #3b82f6;
            color: #1e40af;
        }

        .help-troubleshoot {
            margin-top: 1.5rem;
        }

        .ts-item {
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }

        .ts-problem {
            font-weight: 700;
            color: #dc2626;
            margin-bottom: 0.5rem;
        }

        .ts-solution {
            color: #4b5563;
            font-size: 0.9rem;
        }

        .rule-explain {
            margin-top: 1.5rem;
        }

        .rule-card-help {
            background: #f8f9fa;
            border: 2px solid var(--green-light);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.25rem;
            display: flex;
            gap: 1.5rem;
        }

        .rule-num {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--green);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            flex-shrink: 0;
        }

        .rule-text p {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .rule-result {
            font-style: italic;
            color: var(--green-dark);
            font-weight: 600;
        }

        .cat-pill {
            background: var(--green);
            color: white;
            padding: 0.2rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-style: normal;
        }

        .learning-timeline {
            margin: 2rem 0;
        }

        .lt-item {
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .lt-month {
            font-weight: 700;
            color: var(--text);
            width: 80px;
            flex-shrink: 0;
        }

        .lt-bar {
            height: 32px;
            background: linear-gradient(90deg, var(--green), #27ae60);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 1rem;
            color: white;
            font-weight: 700;
            font-size: 0.85rem;
            transition: width 1s ease;
            min-width: 60px;
        }

        .lt-desc {
            color: var(--muted);
            font-size: 0.88rem;
        }

        .learning-note {
            background: #f0fdf4;
            border-left: 4px solid var(--green);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: #166534;
            font-weight: 600;
            margin-top: 1.5rem;
        }

        .help-code {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.88rem;
            margin: 1rem 0;
        }

        .priority-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.25rem;
            margin-top: 1.5rem;
        }

        .priority-item {
            padding: 1.25rem;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .priority-badge {
            display: inline-block;
            padding: 0.35rem 0.9rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 800;
            text-transform: uppercase;
            margin-bottom: 0.75rem;
        }

        .p-critical {
            background: #fee2e2;
            color: #991b1b;
        }

        .p-high {
            background: #fef3c7;
            color: #92400e;
        }

        .p-medium {
            background: #e0e7ff;
            color: #3730a3;
        }

        .contact-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .contact-card {
            background: #f8f9fa;
            border-radius: 14px;
            padding: 2rem 1.5rem;
            text-align: center;
        }

        .contact-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .contact-card h4 {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .contact-card p {
            margin-bottom: 0.5rem;
        }

        .contact-time {
            font-size: 0.82rem;
            color: var(--muted);
        }

        @media (max-width: 900px) {
            .auth-container {
                grid-template-columns: 1fr;
            }

            .auth-benefits {
                position: static;
            }
        }

        /* ML Status Badge in Dashboard Header */
        #mlStatusContainer {
            background: #f8fafc;
            padding: 0.4rem 0.75rem;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            display: inline-flex !important;
        }

        #mlStatusDot {
            box-shadow: 0 0 8px currentColor;
        }

        .dash-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
            gap: 2rem;
        }

        @media (max-width: 768px) {
            .dash-header {
                flex-direction: column;
                gap: 1rem;
            }

            .dash-header>div:last-child {
                text-align: left !important;
            }

            #mlStatusContainer {
                justify-content: flex-start !important;
            }
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .auth-social {
                grid-template-columns: 1fr;
            }

            .help-header {
                padding: 2rem 1.5rem;
            }

            .help-content {
                padding: 2rem 1.5rem;
            }
        }
    </style>
</head>

<body>
    <!-- ===== NAVBAR ===== -->
    <nav class="navbar">
        <div class="navbar-content">
            <div class="logo">💰 M-Pesa Financial Analyzer</div>
            <div class="nav-links" id="navLinks" style="display:none;">
                <a class="nav-link" onclick="showScreen('dashboard')">Dashboard</a>
                <a class="nav-link" onclick="showScreen('upload')">Upload New</a>
                <a class="nav-link" onclick="showScreen('profile')">Profile</a>
                <a class="nav-link" onclick="showScreen('help')">Help</a>
            </div>
            <div class="user-info" id="userInfo">
                <button id="navSignInBtn" class="btn btn-primary btn-sm" onclick="showScreen('login')">Sign in</button>
            </div>
        </div>
    </nav>

    <!-- ===== FLOW INDICATOR ===== -->
    <div class="flow-bar" id="flowBar">
        <div class="flow-steps">
            <div class="flow-step" id="fs0">
                <div class="flow-dot">1</div>Upload PDF
            </div>
            <div class="flow-step" id="fs1">
                <div class="flow-dot">2</div>Smart Rules
            </div>
            <div class="flow-step" id="fs2">
                <div class="flow-dot">3</div>Processing
            </div>
            <div class="flow-step" id="fs3">
                <div class="flow-dot">4</div>Teach Merchants
            </div>
            <div class="flow-step" id="fs4">
                <div class="flow-dot">5</div>Insights
            </div>
        </div>
    </div>

    <div class="container">

        <!-- ========================================================
             SCREEN 0 — LANDING PAGE
        ======================================================== -->
        <div class="screen active" id="landingScreen">
            <div class="landing-wrap">

                <!-- Hero -->
                <div class="hero">
                    <h1 class="hero-title">💰 M-Pesa Financial Analyzer</h1>
                    <p class="hero-subtitle">Transform your M-Pesa statements into actionable financial insights — in
                        under 2 minutes</p>
                    <div class="hero-cta">
                        <button class="btn-hero" onclick="showScreen('login')">Get Started</button>
                        <button class="btn-hero-ghost"
                            onclick="document.getElementById('howVideo').scrollIntoView({behavior:'smooth'})">Watch How
                            It Works</button>
                    </div>
                </div>

                <!-- VIDEO SECTION -->
                <div class="landing-video-section" id="howVideo">
                    <div class="section-label">See It In Action</div>
                    <h2 class="section-heading">Real App · Real Flow</h2>
                    <p class="section-sub">Watch the actual app — from sign-in to your full financial dashboard.</p>

                    <div class="video-shell"
                        style="border-radius: 20px; overflow: hidden; box-shadow: 0 16px 48px rgba(0,0,0,0.25); background: #0d1f35; max-width: 960px; margin: 0 auto;">
                        <video src="walkthrough.mp4" autoplay loop muted playsinline
                            style="width: 100%; display: block; max-height: 480px; object-fit: cover;"
                            title="M-Pesa Financial Analyzer — App Walkthrough">
                            Your browser does not support the video tag.
                        </video>

                        <!-- Chapter labels overlaid at the bottom -->
                        <div
                            style="background: linear-gradient(transparent, rgba(0,0,0,0.75)); padding: 1.5rem 2rem 1.25rem; display: flex; gap: 1.25rem; flex-wrap: wrap;">
                            <div
                                style="color: rgba(255,255,255,0.7); font-size: 0.8rem; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 0.5rem; width: 100%;">
                                App Pages</div>
                            <div
                                style="color: white; font-size: 0.85rem; background: rgba(255,255,255,0.12); border-radius: 20px; padding: 0.3rem 0.8rem;">
                                🏠 Landing</div>
                            <div
                                style="color: white; font-size: 0.85rem; background: rgba(255,255,255,0.12); border-radius: 20px; padding: 0.3rem 0.8rem;">
                                🔐 Sign In</div>
                            <div
                                style="color: white; font-size: 0.85rem; background: rgba(255,255,255,0.12); border-radius: 20px; padding: 0.3rem 0.8rem;">
                                📤 Upload PDF</div>
                            <div
                                style="color: white; font-size: 0.85rem; background: rgba(255,255,255,0.12); border-radius: 20px; padding: 0.3rem 0.8rem;">
                                ⚙️ Smart Rules</div>
                            <div
                                style="color: white; font-size: 0.85rem; background: rgba(255,255,255,0.12); border-radius: 20px; padding: 0.3rem 0.8rem;">
                                📊 Dashboard</div>
                        </div>
                    </div>
                </div>

                <!-- Steps -->
                <div class="steps-section">
                    <div class="section-label">The Process</div>
                    <h2 class="section-heading">Your Journey to Financial Clarity</h2>
                    <p class="section-sub">Five simple steps, fully guided.</p>
                    <div class="steps-grid">
                        <div class="step-card">
                            <div class="step-num">1</div>
                            <div class="step-icon">📤</div>
                            <h3>Upload PDF</h3>
                            <p>Upload your password-protected M-Pesa statement — we handle the rest</p>
                        </div>
                        <div class="step-card">
                            <div class="step-num">2</div>
                            <div class="step-icon">⚙️</div>
                            <h3>Set Smart Rules</h3>
                            <p>Configure how Send Money transactions are categorized to match your lifestyle</p>
                        </div>
                        <div class="step-card">
                            <div class="step-num">3</div>
                            <div class="step-icon">🔄</div>
                            <h3>Auto-Process</h3>
                            <p>5-stage pipeline extracts and classifies 2,000+ transactions in ~30 seconds</p>
                        </div>
                        <div class="step-card">
                            <div class="step-num">4</div>
                            <div class="step-icon">🎓</div>
                            <h3>Teach Once</h3>
                            <p>Label unknown merchants once — the system remembers forever</p>
                        </div>
                        <div class="step-card">
                            <div class="step-num">5</div>
                            <div class="step-icon">📊</div>
                            <h3>Get Insights</h3>
                            <p>Personalized charts, savings opportunities, and actionable recommendations</p>
                        </div>
                    </div>
                </div>

                <!-- Features -->
                <div class="features-section">
                    <h2 class="section-heading" style="text-align:center; margin-bottom:1.5rem;">Why M-Pesa Analyzer?
                    </h2>
                    <div class="features-grid">
                        <div class="feature-card"><span class="feature-icon">⚡</span>
                            <h4>90% Accuracy</h4>
                            <p>Automated ML categorization</p>
                        </div>
                        <div class="feature-card"><span class="feature-icon">💰</span>
                            <h4>KES 445K/Year</h4>
                            <p>Average savings identified</p>
                        </div>
                        <div class="feature-card"><span class="feature-icon">🎯</span>
                            <h4>Smart Rules</h4>
                            <p>Recurring pattern detection</p>
                        </div>
                        <div class="feature-card"><span class="feature-icon">🧠</span>
                            <h4>Gets Smarter</h4>
                            <p>Learns from every correction</p>
                        </div>
                        <div class="feature-card"><span class="feature-icon">🔒</span>
                            <h4>Private & Secure</h4>
                            <p>Your data never leaves you</p>
                        </div>
                    </div>
                </div>

                <!-- CTA -->
                <div class="cta-strip">
                    <h2>Ready to Take Control of Your Finances?</h2>
                    <button class="btn btn-primary btn-lg" onclick="showScreen('login')">Start Analyzing →</button>
                </div>
            </div>
        </div>

        <!-- ========================================================
             SCREEN 1 — PDF UPLOAD
        ======================================================== -->
        <div class="screen" id="uploadScreen">
            <div class="upload-wrap">
                <div class="card">
                    <h1 class="card-title">📤 Upload M-Pesa Statement</h1>
                    <p class="card-subtitle">Upload your PDF and enter your password to begin. We'll extract every
                        transaction automatically.</p>

                    <div class="upload-area" id="uploadArea">
                        <span class="upload-icon">📄</span>
                        <div class="upload-text">Drop your PDF or CSV here or click to browse</div>
                        <div class="upload-hint">M-Pesa PDF (password-protected) and CSV supported</div>
                        <input type="file" id="fileInput" accept=".pdf,.csv" style="display:none;">
                    </div>

                    <div class="form-group">
                        <label class="form-label">PDF Password</label>
                        <input type="password" class="form-input" id="pdfPassword"
                            placeholder="Enter your M-Pesa statement password">
                    </div>

                    <div class="alert alert-info">
                        <span style="font-size:1.1rem;">ℹ️</span>
                        <div><strong>First time?</strong> After uploading, you'll set your Smart Money Rules before
                            processing. It only takes 2 minutes!</div>
                    </div>

                    <div style="display:flex; gap:1rem;">
                        <button class="btn btn-secondary" onclick="showScreen('login')">← Back</button>
                        <button class="btn btn-primary" id="processBtn" onclick="goToSmartRules()" disabled
                            style="flex:1;">Next: Set Smart Rules →</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================================
             SCREEN 2 — SMART MONEY RULES
        ======================================================== -->
        <div class="screen" id="smartrulesScreen">
            <div class="rules-wrap">
                <div class="rules-page-header">
                    <div class="rules-page-icon">⚙️</div>
                    <div>
                        <h1>Smart Money Rules</h1>
                        <p>These rules tell our system how to classify your <strong>Send Money</strong> transactions
                            before processing begins. Set thresholds once — the system remembers.</p>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title" style="font-size:1.3rem;">Configure Categorization Rules</h2>
                    <p class="card-subtitle">Adjust the thresholds below to match your personal spending patterns.</p>

                    <div class="rules-grid">
                        <!-- Rule 1 -->
                        <div class="rule-card">
                            <div class="rule-card-header">
                                <span class="rule-pill">Rule 1</span>
                                <span class="rule-card-title">Recurring + High Amount</span>
                            </div>
                            <div class="field-row">
                                <div class="field-group">
                                    <label>Min Occurrences</label>
                                    <input type="number" value="2" min="1" id="rule1-freq" oninput="updatePreview()">
                                </div>
                                <div class="field-group">
                                    <label>Amount Threshold (KES)</label>
                                    <input type="number" value="500" min="0" step="50" id="rule1-amount"
                                        oninput="updatePreview()">
                                </div>
                            </div>
                            <div class="field-group">
                                <label>Categorize As</label>
                                <select id="rule1-cat">
                                    <option value="Friends &amp; Family" selected>Friends &amp; Family</option>
                                    <option value="Merchant">Merchant</option>
                                </select>
                            </div>
                            <div class="rule-arrow">→ Recurring + Amount ≥ threshold = <strong>Friends &amp;
                                    Family</strong></div>
                        </div>

                        <!-- Rule 2 -->
                        <div class="rule-card">
                            <div class="rule-card-header">
                                <span class="rule-pill">Rule 2</span>
                                <span class="rule-card-title">Recurring + Low Amount</span>
                            </div>
                            <div class="field-row">
                                <div class="field-group">
                                    <label>Min Occurrences</label>
                                    <input type="number" value="2" min="1" id="rule2-freq" oninput="updatePreview()">
                                </div>
                                <div class="field-group">
                                    <label>Amount Threshold (KES)</label>
                                    <input type="number" value="500" min="0" step="50" id="rule2-amount"
                                        oninput="updatePreview()">
                                </div>
                            </div>
                            <div class="field-group">
                                <label>Categorize As</label>
                                <select id="rule2-cat">
                                    <option value="Merchant" selected>Merchant</option>
                                    <option value="Friends &amp; Family">Friends &amp; Family</option>
                                </select>
                            </div>
                            <div class="rule-arrow">→ Recurring + Amount &lt; threshold = <strong>Merchant</strong>
                            </div>
                        </div>

                        <!-- Rule 3 -->
                        <div class="rule-card">
                            <div class="rule-card-header">
                                <span class="rule-pill">Rule 3</span>
                                <span class="rule-card-title">One-Time Transactions</span>
                            </div>
                            <div class="field-group" style="margin-bottom:0.75rem;">
                                <label>Categorize As</label>
                                <select id="rule3-cat">
                                    <option value="Merchant" selected>Merchant</option>
                                    <option value="Friends &amp; Family">Friends &amp; Family</option>
                                </select>
                            </div>
                            <div class="rule-arrow">→ Non-recurring, any amount = <strong>default category</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Preview -->
                    <div class="rules-preview">
                        <h3>📊 Live Rule Preview — Estimated Impact on Your Data</h3>
                        <div class="preview-stats">
                            <div class="preview-stat">
                                <div class="preview-stat-value" id="prev1">342</div>
                                <div class="preview-stat-label">Rule 1 Matches</div>
                            </div>
                            <div class="preview-stat">
                                <div class="preview-stat-value" id="prev2">187</div>
                                <div class="preview-stat-label">Rule 2 Matches</div>
                            </div>
                            <div class="preview-stat">
                                <div class="preview-stat-value" id="prev3">250</div>
                                <div class="preview-stat-label">Rule 3 Defaults</div>
                            </div>
                        </div>
                    </div>

                    <div class="rules-actions">
                        <button class="btn btn-secondary" onclick="showScreen('upload')">← Back to Upload</button>
                        <button class="btn btn-primary" style="flex:1;" onclick="startProcessing()">Process Statement
                            →</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================================
             SCREEN 3 — PROCESSING
        ======================================================== -->
        <div class="screen" id="processingScreen">
            <div class="processing-wrap">
                <div class="card">
                    <h1 class="card-title">🔄 Processing Your Statement</h1>
                    <p class="card-subtitle">Running your M-Pesa PDF through our 5-stage pipeline...</p>

                    <div class="progress-steps">
                        <div class="p-step active" id="ps1">
                            <div class="p-circle">1</div>
                            <div class="p-label">Extract PDF</div>
                        </div>
                        <div class="p-step" id="ps2">
                            <div class="p-circle">2</div>
                            <div class="p-label">Identify Types</div>
                        </div>
                        <div class="p-step" id="ps3">
                            <div class="p-circle">3</div>
                            <div class="p-label">Categorize</div>
                        </div>
                        <div class="p-step" id="ps4">
                            <div class="p-circle">4</div>
                            <div class="p-label">Apply Rules</div>
                        </div>
                        <div class="p-step" id="ps5">
                            <div class="p-circle">5</div>
                            <div class="p-label">Clean Data</div>
                        </div>
                    </div>

                    <div class="prog-bar">
                        <div class="prog-fill" id="progFill" style="width:0%;"></div>
                    </div>
                    <div class="prog-text" id="progText">Extracting PDF data...</div>

                    <div class="stats-row">
                        <div class="stat-box">
                            <div class="stat-val" id="sT">-</div>
                            <div class="stat-lab">Transactions</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-val" id="sC">-</div>
                            <div class="stat-lab">Categories</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-val" id="sM">-</div>
                            <div class="stat-lab">Merchants</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================================
             SCREEN 4 — MERCHANT LEARNER
        ======================================================== -->
        <div class="screen" id="learningScreen">
            <div class="learn-wrap">
                <div class="card">
                    <h1 class="card-title">🎓 Teach Me Your Merchants</h1>
                    <p class="card-subtitle">Label these unknown merchants once — I'll remember forever and
                        auto-categorize them next time.</p>

                    <div class="stats-row">
                        <div class="stat-box">
                            <div class="stat-val" id="lProgress">0/5</div>
                            <div class="stat-lab">Progress</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-val">2,710</div>
                            <div class="stat-lab">Auto-Labelled</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-val" id="lRemain">5</div>
                            <div class="stat-lab">Remaining</div>
                        </div>
                    </div>

                    <div id="merchantsList" style="margin-top:1.5rem;"></div>
                </div>
            </div>
        </div>

        <!-- ========================================================
             SCREEN 5 — DASHBOARD
        ======================================================== -->
        <div class="screen" id="dashboardScreen">
            <div class="dash-wrap">
                <!-- Header -->
                <div class="dash-header">
                    <div>
                        <div class="dash-title">Financial Insights Dashboard</div>
                        <div class="dash-sub" id="sumPeriod">All Time · Feb 2024 – Feb 2026</div>
                    </div>
                    <div style="text-align: right;">
                        <div class="dash-date" id="sumTxns">2,715 transactions</div>
                        <div id="mlStatusContainer"
                            style="margin-top: 0.5rem; display: flex; justify-content: flex-end; align-items: center; gap: 0.5rem; font-size: 0.75rem;">
                            <span id="mlStatusDot"
                                style="width: 8px; height: 8px; border-radius: 50%; background: #94a3b8;"></span>
                            <span id="mlStatusText" style="color: #64748b; font-weight: 600;">ML Model: Standby</span>
                        </div>
                    </div>
                </div>

                <!-- Period Filter -->
                <div class="period-filter-bar" id="periodBar">
                    <div class="period-bar-inner">
                        <div class="period-presets">
                            <span class="period-label">📅 View Period:</span>
                            <button class="period-chip active" onclick="setPeriod('all', this)">All Time</button>
                            <button class="period-chip" onclick="setPeriod('thisyear', this)">This Year</button>
                            <button class="period-chip" onclick="setPeriod('lastyear', this)">Last Year</button>
                            <button class="period-chip" onclick="setPeriod('6m', this)">Last 6 Months</button>
                            <button class="period-chip" onclick="setPeriod('3m', this)">Last 3 Months</button>
                            <button class="period-chip" onclick="setPeriod('1m', this)">This Month</button>
                        </div>
                        <div class="period-custom">
                            <span class="period-label">Custom:</span>
                            <div class="period-custom-fields">
                                <select id="filterMonth" onchange="applyCustomPeriod()">
                                    <option value="">All Months</option>
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                                <select id="filterYear" onchange="applyCustomPeriod()">
                                    <option value="">All Years</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                </select>
                                <button class="period-range-btn" onclick="toggleRangePicker()">📆 Date Range</button>
                            </div>
                        </div>
                    </div>
                    <!-- Range picker (hidden by default) -->
                    <div class="range-picker" id="rangePicker" style="display:none;">
                        <div class="range-fields">
                            <div class="range-field">
                                <label>From</label>
                                <input type="date" id="rangeFrom" value="2024-02-01" onchange="applyRange()">
                            </div>
                            <div class="range-sep">→</div>
                            <div class="range-field">
                                <label>To</label>
                                <input type="date" id="rangeTo" value="2026-02-28" onchange="applyRange()">
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="applyRange()">Apply</button>
                            <button class="btn btn-secondary btn-sm" onclick="clearRange()">Clear</button>
                        </div>
                    </div>
                    <!-- Active filter pill -->
                    <div class="active-filter" id="activeFilter" style="display:none;">
                        <span id="activeFilterText"></span>
                        <button onclick="clearAllFilters()"
                            style="background:none;border:none;cursor:pointer;color:inherit;font-size:0.9rem;margin-left:0.4rem;">✕</button>
                    </div>
                </div>

                <!-- Summary -->
                <div class="summary-row">
                    <div class="sum-card">
                        <div class="sum-label">Total Spent</div>
                        <div class="sum-value" id="sumSpent">KES 186K</div>
                        <div class="sum-note">Over selected period</div>
                    </div>
                    <div class="sum-card">
                        <div class="sum-label">Total Received</div>
                        <div class="sum-value" id="sumReceived">KES 54K</div>
                        <div class="sum-note pos">Over selected period</div>
                    </div>
                    <div class="sum-card">
                        <div class="sum-label">Potential Savings</div>
                        <div class="sum-value" id="sumSavings">KES 37K</div>
                        <div class="sum-note pos">Per month if optimized</div>
                    </div>
                    <div class="sum-card">
                        <div class="sum-label">Recommendations</div>
                        <div class="sum-value" id="sumRecs">3</div>
                        <div class="sum-note">Critical priority</div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="tabs-wrap">
                    <div class="tabs-nav">
                        <button class="tab-btn active" onclick="switchTab('rec', this)">🎯 Recommendations</button>
                        <button class="tab-btn" onclick="switchTab('ins', this)">💡 Insights</button>
                        <button class="tab-btn" onclick="switchTab('ana', this)">📊 Analytics</button>
                    </div>

                    <!-- RECOMMENDATIONS (rendered dynamically by JS) -->
                    <div class="tab-panel active" id="panelRec">
                        <div class="panel-title"><span>🎯</span> Top Recommendations</div>
                    </div>

                    <!-- INSIGHTS (rendered dynamically by JS) -->
                    <div class="tab-panel" id="panelIns">
                        <div class="panel-title"><span>💡</span> Financial Insights</div>
                    </div>

                    <!-- ANALYTICS -->
                    <div class="tab-panel" id="panelAna">
                        <div class="panel-title"><span>📊</span> Visual Analytics</div>
                        <div class="charts-grid">
                            <div class="chart-box">
                                <h3>Top Spending Categories</h3><canvas id="catChart"></canvas>
                            </div>
                            <div class="chart-box">
                                <h3>Monthly Spending vs Income</h3><canvas id="trendChart"></canvas>
                            </div>
                            <div class="chart-box">
                                <h3>Category Spending Breakdown</h3><canvas id="essChart"></canvas>
                            </div>
                            <div class="chart-box">
                                <h3>Payday Week Effect</h3><canvas id="savChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- SMART MONEY RULES removed from dashboard — configured during onboarding -->
                </div>
            </div>
        </div>

        <!-- ========================================================
             SCREEN 6 — DIRECTORY PAGE
        ======================================================== -->
        <div class="screen" id="directoryScreen">
            <div style="padding: 2rem 0;">
                <div class="dir-header">
                    <button class="back-btn" onclick="showScreen('dashboard')">← Back</button>
                    <div>
                        <h1 style="font-size:1.6rem; font-weight:800; margin-bottom:0.25rem;" id="dirTitle">Optimization
                            Tools</h1>
                        <p style="opacity:0.85; font-size:0.9rem;" id="dirSub">Choose a tool to start optimizing your
                            finances</p>
                    </div>
                </div>
                <div class="dir-grid" id="dirGrid"></div>
            </div>
        </div>

        <!-- ========================================================
             SCREEN 7 — TOOL DETAIL PAGE
        ======================================================== -->
        <div class="screen" id="detailScreen">
            <div class="detail-wrap" id="detailContent"></div>
        </div>

        <!-- AUTHENTICATION SCREENS TO ADD -->

        <!-- ========================================================
     SCREEN: SIGN UP (REMOVED - Using Google Auth)
======================================================== -->

        <!-- ========================================================
     SCREEN: LOGIN
======================================================== -->
        <div class="screen" id="loginScreen">
            <div class="auth-container">
                <div class="auth-card">
                    <div class="auth-header">
                        <div class="auth-logo">💰</div>
                        <h1 class="auth-title">Welcome Back</h1>
                        <p class="auth-subtitle">Sign in to continue analyzing your finances</p>
                    </div>

                    <div style="margin-top: 2rem; margin-bottom: 2rem;">
                        <button class="btn btn-full" onclick="signInWithGoogle()"
                            style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; background-color: #ffffff; color: #3c4043; border: 1px solid #dadce0; box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15); font-family: 'Google Sans', arial, sans-serif; font-weight: 500; font-size: 1rem; border-radius: 4px; padding: 0.75rem; transition: background-color 0.2s, box-shadow 0.2s; cursor: pointer;">
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg"
                                alt="Google Logo" style="width: 24px; height: 24px;">
                            Sign in with Google
                        </button>
                    </div>

                    <!-- Navigation buttons -->
                    <div style="display: flex; gap: 1rem; justify-content: space-between; margin-top: 0.5rem;">
                        <button class="btn btn-secondary" onclick="showScreen('landing')" style="flex: 1;">← Back to
                            Home</button>
                        <button class="btn btn-primary" onclick="showScreen('upload')" style="flex: 1;">Upload PDF
                            →</button>
                    </div>
                </div>

                <div class="auth-stats">
                    <div class="stat-pill">
                        <div class="stat-pill-value">30,000+</div>
                        <div class="stat-pill-label">Active Users</div>
                    </div>
                    <div class="stat-pill">
                        <div class="stat-pill-value">KES 1.2B</div>
                        <div class="stat-pill-label">Total Savings</div>
                    </div>
                    <div class="stat-pill">
                        <div class="stat-pill-value">95%</div>
                        <div class="stat-pill-label">Satisfaction</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================================
     SCREEN: FORGOT PASSWORD
======================================================== -->
        <div class="screen" id="forgotpasswordScreen">
            <div class="auth-container">
                <div class="auth-card" style="max-width: 480px;">
                    <div class="auth-header">
                        <div class="auth-logo">🔐</div>
                        <h1 class="auth-title">Reset Password</h1>
                        <p class="auth-subtitle">Enter your email and we'll send you a reset link</p>
                    </div>

                    <form class="auth-form" onsubmit="handleForgotPassword(event)">
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-input" id="resetEmail" placeholder="john@example.com"
                                required autofocus>
                        </div>

                        <button type="submit" class="btn btn-primary btn-full">Send Reset Link</button>
                    </form>

                    <div class="auth-footer">
                        Remember your password? <a href="#" onclick="showScreen('login'); return false;">Sign In</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================================
     SCREEN: HELP CENTER
======================================================== -->
        <div class="screen" id="helpScreen">
            <div class="help-wrap">
                <!-- Header -->
                <div class="help-header">
                    <div class="help-header-content">
                        <button class="back-btn" onclick="showScreen('dashboard')">← Back to Dashboard</button>
                        <h1 class="help-title">💡 Help Center</h1>
                        <p class="help-subtitle">Everything you need to know about M-Pesa Financial Analyzer</p>
                    </div>

                    <!-- Search -->
                    <div class="help-search">
                        <input type="text" class="help-search-input" id="helpSearch" placeholder="Search for help..."
                            oninput="searchHelp(this.value)">
                        <span class="help-search-icon">🔍</span>
                    </div>
                </div>

                <!-- Quick Links -->
                <div class="help-quick-links">
                    <h3>Popular Topics</h3>
                    <div class="quick-links-grid">
                        <a href="#getting-started" class="quick-link-card" onclick="scrollToHelp('getting-started')">
                            <span class="ql-icon">🚀</span>
                            <span class="ql-title">Getting Started</span>
                        </a>
                        <a href="#upload-pdf" class="quick-link-card" onclick="scrollToHelp('upload-pdf')">
                            <span class="ql-icon">📤</span>
                            <span class="ql-title">Upload PDF</span>
                        </a>
                        <a href="#smart-rules" class="quick-link-card" onclick="scrollToHelp('smart-rules')">
                            <span class="ql-icon">⚙️</span>
                            <span class="ql-title">Smart Rules</span>
                        </a>
                        <a href="#security" class="quick-link-card" onclick="scrollToHelp('security')">
                            <span class="ql-icon">🔒</span>
                            <span class="ql-title">Security & Privacy</span>
                        </a>
                    </div>
                </div>

                <!-- Help Content -->
                <div class="help-content">
                    <!-- Getting Started -->
                    <div class="help-section" id="getting-started">
                        <h2 class="help-section-title">🚀 Getting Started</h2>

                        <div class="help-article">
                            <h3>What is M-Pesa Financial Analyzer?</h3>
                            <p>M-Pesa Financial Analyzer is an intelligent platform that transforms your M-Pesa
                                statements into actionable financial insights. Upload your PDF statement, and within
                                minutes, you'll have:</p>
                            <ul>
                                <li>Automatic transaction categorization (90%+ accuracy)</li>
                                <li>Personalized spending recommendations</li>
                                <li>Interactive charts and analytics</li>
                                <li>Smart Money Rules for recurring payments</li>
                                <li>Savings opportunities worth KES 30K-180K per year</li>
                            </ul>
                        </div>

                        <div class="help-article">
                            <h3>How does it work?</h3>
                            <ol class="help-steps">
                                <li><strong>Upload:</strong> Drop your M-Pesa PDF statement and enter its password</li>
                                <li><strong>Configure:</strong> Set Smart Money Rules for "Send Money" transactions</li>
                                <li><strong>Process:</strong> Our 5-stage pipeline extracts and categorizes 2,000+
                                    transactions in ~30 seconds</li>
                                <li><strong>Teach:</strong> Label unknown merchants once — system remembers forever</li>
                                <li><strong>Analyze:</strong> View recommendations, insights, and savings opportunities
                                </li>
                            </ol>
                        </div>

                        <div class="help-article">
                            <h3>Who should use this?</h3>
                            <p>Anyone who uses M-Pesa regularly and wants to:</p>
                            <ul>
                                <li>Understand where their money goes</li>
                                <li>Reduce M-Pesa transaction fees</li>
                                <li>Find hidden savings opportunities</li>
                                <li>Track spending patterns over time</li>
                                <li>Make data-driven financial decisions</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Upload & Processing -->
                    <div class="help-section" id="upload-pdf">
                        <h2 class="help-section-title">📤 Uploading Your Statement</h2>

                        <div class="help-article">
                            <h3>How do I get my M-Pesa statement?</h3>
                            <p><strong>Option 1: Email Request</strong></p>
                            <ol>
                                <li>Open your email app and compose new message</li>
                                <li>Send to: <code>statement@safaricom.co.ke</code></li>
                                <li>Subject: <code>Statement</code></li>
                                <li>Body: Leave blank or type "Statement"</li>
                                <li>Send from the email registered with your M-Pesa account</li>
                                <li>Receive PDF within 15-30 minutes</li>
                            </ol>

                            <p><strong>Option 2: M-Pesa App</strong></p>
                            <ol>
                                <li>Open M-Pesa app → Menu → My Account</li>
                                <li>Select "Request Statement"</li>
                                <li>Choose date range (max 24 months)</li>
                                <li>PDF sent to your registered email</li>
                            </ol>
                        </div>

                        <div class="help-article">
                            <h3>What's the statement password?</h3>
                            <p>The PDF password is your <strong>M-Pesa PIN</strong> — the same 4-digit PIN you use for
                                transactions.</p>
                            <div class="help-note help-note-warning">
                                <strong>⚠️ Important:</strong> Your PIN never leaves your device. We use it only to
                                decrypt the PDF locally in your browser.
                            </div>
                        </div>

                        <div class="help-article">
                            <h3>Supported file types</h3>
                            <ul>
                                <li>✅ PDF files (.pdf) from Safaricom M-Pesa</li>
                                <li>✅ Password-protected PDFs</li>
                                <li>❌ Excel, CSV, images, or screenshots</li>
                                <li>❌ Bank statements (M-Pesa only)</li>
                            </ul>
                        </div>

                        <div class="help-article">
                            <h3>Maximum file size</h3>
                            <p>Up to <strong>25 MB</strong> — typically covers 24 months of transactions for most users.
                            </p>
                        </div>

                        <div class="help-article">
                            <h3>Troubleshooting upload errors</h3>
                            <div class="help-troubleshoot">
                                <div class="ts-item">
                                    <div class="ts-problem">❌ "Invalid password"</div>
                                    <div class="ts-solution">→ Double-check your M-Pesa PIN. Try again with correct 4
                                        digits.</div>
                                </div>
                                <div class="ts-item">
                                    <div class="ts-problem">❌ "File too large"</div>
                                    <div class="ts-solution">→ Request a shorter date range (e.g., 12 months instead of
                                        24).</div>
                                </div>
                                <div class="ts-item">
                                    <div class="ts-problem">❌ "Unsupported file"</div>
                                    <div class="ts-solution">→ Only M-Pesa PDF statements work. Check file type.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Smart Money Rules -->
                    <div class="help-section" id="smart-rules">
                        <h2 class="help-section-title">⚙️ Smart Money Rules</h2>

                        <div class="help-article">
                            <h3>What are Smart Money Rules?</h3>
                            <p>Smart Money Rules automatically categorize your "Send Money" transactions based on
                                patterns you define. Instead of labeling each transaction manually, set rules once and
                                the system applies them forever.</p>
                        </div>

                        <div class="help-article">
                            <h3>The 3 Default Rules</h3>
                            <div class="rule-explain">
                                <div class="rule-card-help">
                                    <div class="rule-num">1</div>
                                    <div class="rule-text">
                                        <strong>Recurring + High Amount</strong>
                                        <p>If you send money to the same person ≥2 times AND amount ≥ KES 500</p>
                                        <p class="rule-result">→ Categorized as: <span class="cat-pill">Friends &
                                                Family</span></p>
                                    </div>
                                </div>

                                <div class="rule-card-help">
                                    <div class="rule-num">2</div>
                                    <div class="rule-text">
                                        <strong>Recurring + Low Amount</strong>
                                        <p>If you send money to the same person ≥2 times AND amount < KES 500</p>
                                                <p class="rule-result">→ Categorized as: <span
                                                        class="cat-pill">Merchant</span></p>
                                    </div>
                                </div>

                                <div class="rule-card-help">
                                    <div class="rule-num">3</div>
                                    <div class="rule-text">
                                        <strong>One-Time Transactions</strong>
                                        <p>Any "Send Money" that doesn't match Rules 1 or 2</p>
                                        <p class="rule-result">→ Categorized as: <span class="cat-pill">Merchant
                                                (default)</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="help-article">
                            <h3>Can I customize these rules?</h3>
                            <p>Yes! You can adjust:</p>
                            <ul>
                                <li><strong>Frequency threshold:</strong> Change "≥2 times" to 3, 4, or more</li>
                                <li><strong>Amount threshold:</strong> Change KES 500 to match your spending</li>
                                <li><strong>Categories:</strong> Switch between "Friends & Family" and "Merchant"</li>
                            </ul>
                            <p>The "Live Preview" shows how many transactions each rule will affect before you apply it.
                            </p>
                        </div>

                        <div class="help-article">
                            <h3>Why do these rules matter?</h3>
                            <p>"Send Money" is M-Pesa's most ambiguous transaction type — it could be rent, groceries,
                                family support, or vendor payments. Rules ensure consistent categorization so your
                                spending insights are accurate.</p>
                        </div>
                    </div>

                    <!-- Merchant Learning -->
                    <div class="help-section" id="merchants">
                        <h2 class="help-section-title">🎓 Merchant Learning</h2>

                        <div class="help-article">
                            <h3>What is merchant learning?</h3>
                            <p>After processing, you'll see 5-50 "unknown" merchants that our system couldn't categorize
                                automatically. You label each one once (e.g., "SUPERMARKET XYZ" = Groceries), and the
                                system remembers forever.</p>
                        </div>

                        <div class="help-article">
                            <h3>How does learning improve over time?</h3>
                            <div class="learning-timeline">
                                <div class="lt-item">
                                    <div class="lt-month">Month 1</div>
                                    <div class="lt-bar" style="width:10%"><span>10%</span></div>
                                    <div class="lt-desc">Label ~500 merchants (30 min)</div>
                                </div>
                                <div class="lt-item">
                                    <div class="lt-month">Month 2</div>
                                    <div class="lt-bar" style="width:75%"><span>75%</span></div>
                                    <div class="lt-desc">Label ~30 new merchants (3 min)</div>
                                </div>
                                <div class="lt-item">
                                    <div class="lt-month">Month 6</div>
                                    <div class="lt-bar" style="width:99%"><span>99%</span></div>
                                    <div class="lt-desc">Label ~5 new merchants (1 min)</div>
                                </div>
                            </div>
                            <p class="learning-note">By month 6, the system auto-categorizes 99% of transactions!</p>
                        </div>

                        <div class="help-article">
                            <h3>Sample amounts — what do they mean?</h3>
                            <p>When labeling a merchant, you'll see sample transaction amounts like:</p>
                            <div class="help-code">Sample amounts: KES 500, 1,200, 800, 600</div>
                            <p>These help you categorize correctly:</p>
                            <ul>
                                <li><strong>KES 20-100 repeatedly</strong> → Likely Transport (matatu, bodaboda)</li>
                                <li><strong>KES 500-2,000 varied</strong> → Likely Groceries or Shopping</li>
                                <li><strong>KES 5,000+ fixed</strong> → Likely Friends & Family or Bills</li>
                            </ul>
                        </div>

                        <div class="help-article">
                            <h3>What if I make a mistake?</h3>
                            <p>No problem! You can always:</p>
                            <ul>
                                <li>Re-upload a statement and re-label</li>
                                <li>Contact support to reset your merchant database</li>
                                <li>Skip merchants you're unsure about (they'll be flagged for next time)</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Security & Privacy -->
                    <div class="help-section" id="security">
                        <h2 class="help-section-title">🔒 Security & Privacy</h2>

                        <div class="help-article">
                            <h3>Is my financial data safe?</h3>
                            <p><strong>Yes. We take security extremely seriously:</strong></p>
                            <ul>
                                <li>✅ Your PDF is decrypted <strong>locally in your browser</strong> — your PIN never
                                    reaches our servers</li>
                                <li>✅ All data is encrypted in transit (TLS 1.3) and at rest (AES-256)</li>
                                <li>✅ No data is ever shared, sold, or used for advertising</li>
                                <li>✅ You can delete all your data anytime from Settings</li>
                            </ul>
                        </div>

                        <div class="help-article">
                            <h3>Who can see my transaction data?</h3>
                            <p><strong>Only you.</strong> Not even our support team can view your raw transactions
                                unless you explicitly share a screenshot or export.</p>
                        </div>

                        <div class="help-article">
                            <h3>Do you store my M-Pesa PIN?</h3>
                            <p><strong>No.</strong> Your PIN is used only to decrypt the PDF in your browser and is
                                never transmitted or stored anywhere.</p>
                        </div>

                        <div class="help-article">
                            <h3>Can I export or delete my data?</h3>
                            <p>Yes, both:</p>
                            <ul>
                                <li><strong>Export:</strong> Download all your data as CSV from Settings → Export Data
                                </li>
                                <li><strong>Delete:</strong> Request full account deletion from Settings → Delete
                                    Account</li>
                            </ul>
                            <div class="help-note help-note-info">
                                Deletion is permanent and cannot be undone. Exports are instant.
                            </div>
                        </div>

                        <div class="help-article">
                            <h3>What happens to my data if I stop using the service?</h3>
                            <p>After <strong>12 months of inactivity</strong>, we'll email you asking if you want to
                                keep your account. If no response within 30 days, data is permanently deleted.</p>
                        </div>
                    </div>

                    <!-- Recommendations & Insights -->
                    <div class="help-section" id="insights">
                        <h2 class="help-section-title">💡 Understanding Your Insights</h2>

                        <div class="help-article">
                            <h3>What are recommendations?</h3>
                            <p>Recommendations are personalized, actionable suggestions based on your actual spending
                                patterns. They identify opportunities to save money, reduce fees, or optimize your
                                finances.</p>
                            <p><strong>Example:</strong> "Reduce M-Pesa fees by 60% → Save KES 12,000/year by bundling
                                transactions"</p>
                        </div>

                        <div class="help-article">
                            <h3>Priority levels explained</h3>
                            <div class="priority-grid">
                                <div class="priority-item">
                                    <span class="priority-badge p-critical">Critical</span>
                                    <p>Immediate action needed — large savings or urgent financial issue</p>
                                </div>
                                <div class="priority-item">
                                    <span class="priority-badge p-high">High</span>
                                    <p>Significant impact — worth addressing within the week</p>
                                </div>
                                <div class="priority-item">
                                    <span class="priority-badge p-medium">Medium</span>
                                    <p>Moderate savings — address when convenient</p>
                                </div>
                            </div>
                        </div>

                        <div class="help-article">
                            <h3>How accurate are savings estimates?</h3>
                            <p>Savings are calculated based on:</p>
                            <ul>
                                <li>Your actual historical spending patterns</li>
                                <li>Industry benchmarks for similar users</li>
                                <li>Current M-Pesa fee structures</li>
                            </ul>
                            <p>Estimates are conservative — many users save <strong>more</strong> than predicted.</p>
                        </div>

                        <div class="help-article">
                            <h3>Period filters — why do numbers change?</h3>
                            <p>The dashboard adapts to your selected time period:</p>
                            <ul>
                                <li><strong>"All Time"</strong> → All transactions in your statement</li>
                                <li><strong>"Last 6 Months"</strong> → Only transactions from the past 6 months</li>
                                <li><strong>"Custom Date Range"</strong> → Transactions within your specified dates</li>
                            </ul>
                            <p>Recommendations recalculate for each period, so a recommendation that shows in "All Time"
                                might not appear in "This Month" if it's not relevant to that shorter window.</p>
                        </div>
                    </div>

                    <!-- Technical FAQs -->
                    <div class="help-section" id="technical">
                        <h2 class="help-section-title">🛠️ Technical FAQs</h2>

                        <div class="help-article">
                            <h3>Which browsers are supported?</h3>
                            <ul>
                                <li>✅ Chrome/Edge 90+ (Recommended)</li>
                                <li>✅ Firefox 88+</li>
                                <li>✅ Safari 14+</li>
                                <li>⚠️ Internet Explorer — Not supported</li>
                            </ul>
                        </div>

                        <div class="help-article">
                            <h3>Can I use this on mobile?</h3>
                            <p>Yes! The interface is fully responsive. However, for the best experience (especially
                                during merchant learning), we recommend using a tablet or desktop.</p>
                        </div>

                        <div class="help-article">
                            <h3>How long does processing take?</h3>
                            <ul>
                                <li><strong>PDF extraction:</strong> 5-10 seconds</li>
                                <li><strong>5-stage pipeline:</strong> 20-30 seconds total</li>
                                <li><strong>Merchant learning:</strong> 1-30 minutes (first time only)</li>
                                <li><strong>Dashboard generation:</strong> 2-5 seconds</li>
                            </ul>
                        </div>

                        <div class="help-article">
                            <h3>Why does the video keep looping?</h3>
                            <p>The landing page demo video is a 2-minute loop showing all 5 steps of the process. Click
                                any chapter on the right sidebar to jump to a specific step.</p>
                        </div>

                        <div class="help-article">
                            <h3>Can I analyze multiple M-Pesa accounts?</h3>
                            <p>Currently, one M-Pesa statement per upload. However, you can:</p>
                            <ul>
                                <li>Upload multiple statements sequentially</li>
                                <li>Compare different time periods using period filters</li>
                                <li>Contact support for multi-account enterprise plans</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Contact Support -->
                    <div class="help-section" id="contact">
                        <h2 class="help-section-title">📧 Contact Support</h2>

                        <div class="help-article">
                            <h3>Still need help?</h3>
                            <p>We're here for you:</p>

                            <div class="contact-methods">
                                <div class="contact-card">
                                    <div class="contact-icon">📧</div>
                                    <h4>Email Support</h4>
                                    <p>support@mpesa-analyzer.com</p>
                                    <p class="contact-time">Response within 24 hours</p>
                                </div>

                                <div class="contact-card">
                                    <div class="contact-icon">💬</div>
                                    <h4>Live Chat</h4>
                                    <p>Mon-Fri, 8am-6pm EAT</p>
                                    <button class="btn btn-primary btn-sm" onclick="openLiveChat()">Start Chat</button>
                                </div>

                                <div class="contact-card">
                                    <div class="contact-icon">📱</div>
                                    <h4>WhatsApp</h4>
                                    <p>+254 700 123 456</p>
                                    <p class="contact-time">Mon-Sat, 9am-5pm</p>
                                </div>
                            </div>
                        </div>

                        <div class="help-article">
                            <h3>Report a bug</h3>
                            <p>Found something not working? Report it:</p>
                            <button class="btn btn-secondary" onclick="openBugReport()">🐛 Report Bug</button>
                        </div>

                        <div class="help-article">
                            <h3>Feature requests</h3>
                            <p>Have an idea to improve M-Pesa Analyzer?</p>
                            <button class="btn btn-secondary" onclick="openFeatureRequest()">💡 Suggest Feature</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ========================================================
             SCREEN 9 — USER PROFILE PAGE
        ======================================================== -->
        <div class="screen" id="profileScreen">
            <div style="padding: 2rem 0; max-width: 800px; margin: 0 auto;">
                <button class="back-btn" onclick="showScreen('dashboard')" style="margin-bottom: 1.5rem;">← Back to
                    Dashboard</button>

                <h1 style="font-size:2rem; font-weight:800; margin-bottom:1.5rem;">User Profile</h1>

                <!-- Profile Info Card -->
                <div
                    style="background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 2rem; display: flex; align-items: center; gap: 1.5rem;">
                    <div id="profileAvatarLg"
                        style="width: 80px; height: 80px; border-radius: 50%; overflow: hidden; background: #e0f2fe; color: #0284c7; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 700; border: 3px solid #f0f9ff;">
                        <!-- Avatar added via JS -->
                    </div>
                    <div>
                        <h2 id="profileNameLg" style="margin: 0 0 0.25rem 0; font-size: 1.5rem; color: #1e293b;">John
                            Doe</h2>
                        <p id="profileEmailLg" style="margin: 0; color: #64748b; font-size: 1rem;">john.doe@example.com
                        </p>
                    </div>
                </div>

                <!-- Progress Section -->
                <div style="margin-bottom: 2rem;">
                    <h2 style="font-size: 1.4rem; font-weight: 700; margin-bottom: 1rem; color: #334155;">Your Progress
                    </h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <!-- Stat 1 -->
                        <div
                            style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border-left: 4px solid #10b981;">
                            <div
                                style="color: #64748b; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;">
                                Statements Analyzed</div>
                            <div style="font-size: 2rem; font-weight: 800; color: #0f172a;" id="statAnalyzed">0</div>
                        </div>
                        <!-- Stat 2 -->
                        <div
                            style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border-left: 4px solid #3b82f6;">
                            <div
                                style="color: #64748b; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;">
                                Rules Configured</div>
                            <div style="font-size: 2rem; font-weight: 800; color: #0f172a;" id="statRules">3</div>
                        </div>
                        <!-- Stat 3 -->
                        <div
                            style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border-left: 4px solid #8b5cf6;">
                            <div
                                style="color: #64748b; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;">
                                Last Upload</div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: #0f172a; margin-top: 0.5rem;"
                                id="statLastUpload">Never</div>
                        </div>
                    </div>

                    <div
                        style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.04); margin-top: 1.5rem;">
                        <h3 style="font-size: 1.1rem; font-weight: 700; margin-bottom: 1rem; color: #334155;">Spending
                            vs Savings Progress</h3>
                        <canvas id="profileProgressChart" style="max-height: 250px;"></canvas>
                    </div>
                </div>

                <!-- History Section -->
                <div style="margin-bottom: 2rem;">
                    <h2 style="font-size: 1.4rem; font-weight: 700; margin-bottom: 1rem; color: #334155;">Past Analysis
                        History</h2>
                    <div id="historyList" style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <div
                            style="background: white; border-radius: 12px; padding: 1rem; color: #64748b; text-align: center; border: 1px dashed #cbd5e1;">
                            No past analysis runs found.
                        </div>
                    </div>
                </div>

                <!-- Account Actions -->
                <div
                    style="background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
                    <h2 style="font-size: 1.4rem; font-weight: 700; margin-bottom: 1rem; color: #334155;">Account
                        Actions</h2>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button onclick="signOutUser()" class="btn btn-secondary">Sign Out</button>
                        <button onclick="clearHistory()" class="btn btn-secondary"
                            style="border-color: #fca5a5; color: #b91c1c;">Clear History</button>
                        <button onclick="resetLearning()" class="btn btn-secondary"
                            style="border-color: #fca5a5; color: #b91c1c;">Reset Learned Merchants</button>
                    </div>
                </div>
            </div>
        </div>

    </div><!-- /container -->

    <script>
        function formatAmount(val) {
            if (val === undefined || val === null) return '0';
            const num = parseFloat(val);
            if (num >= 1000000) return (num / 1000000).toFixed(3).replace(/\.?0+$/, '') + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1).replace(/\.?0+$/, '') + 'K';
            return num.toLocaleString();
        }

        // ===================================================================
        // SCREEN & FLOW MANAGEMENT
        // ===================================================================
        const flowMap = {
            upload: 0, smartrules: 1, processing: 2, learning: 3, dashboard: 4
        };

        function showScreen(id) {
            const screenEl = document.getElementById(id + 'Screen');
            if (!screenEl) {
                console.error(`Screen not found: ${id}Screen`);
                return;
            }

            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screenEl.classList.add('active');
            window.scrollTo(0, 0);

            const fb = document.getElementById('flowBar');
            const inFlow = ['upload', 'smartrules', 'processing', 'learning', 'dashboard'].includes(id);
            if (fb) fb.classList.toggle('visible', inFlow);

            if (inFlow) {
                const cur = flowMap[id] ?? -1;
                document.querySelectorAll('.flow-step').forEach((el, i) => {
                    el.classList.remove('active', 'done');
                    if (i < cur) el.classList.add('done');
                    else if (i === cur) el.classList.add('active');
                });
            }

            if (id === 'dashboard' || id === 'profile') {
                const nL = document.getElementById('navLinks');
                const uI = document.getElementById('userInfo');
                if (nL) nL.style.display = 'flex';
                if (uI) uI.style.display = 'flex';
                setTimeout(() => {
                    if (typeof initCharts === 'function') initCharts();
                    if (typeof applyPeriod === 'function' && typeof periodData !== 'undefined') applyPeriod(periodData.all);
                }, 120);
            }
            if (id === 'landing') {
                const nL = document.getElementById('navLinks');
                const uI = document.getElementById('userInfo');
                if (typeof currentUser !== 'undefined' && currentUser) {
                    if (nL) nL.style.display = 'none';
                    if (uI) uI.style.display = 'none';
                } else {
                    if (nL) nL.style.display = 'none';
                    if (uI) uI.style.display = 'flex';
                }
            }
        }

        // ===================================================================
        // UPLOAD SCREEN
        // ===================================================================
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const processBtn = document.getElementById('processBtn');

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', e => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', e => { if (e.target.files[0]) handleFile(e.target.files[0]); });

        let selectedFile = null;
        function handleFile(file) {
            selectedFile = file;
            uploadArea.innerHTML = `<span class="upload-icon">✅</span><div class="upload-text">${file.name}</div><div class="upload-hint">Ready to proceed</div>`;
            processBtn.disabled = false;

            // Hide password field if it's a CSV
            const pwGroup = document.getElementById('pdfPassword').parentElement.parentElement;
            if (file.name.toLowerCase().endsWith('.csv')) {
                pwGroup.style.display = 'none';
            } else {
                pwGroup.style.display = 'block';
            }
        }

        function goToSmartRules() {
            if (selectedFile && selectedFile.name.toLowerCase().endsWith('.pdf')) {
                const pw = document.getElementById('pdfPassword').value;
                if (!pw) { alert('Please enter the PDF password'); return; }
            }
            showScreen('smartrules');
        }

        // ===================================================================
        // SMART RULES (ONBOARDING)
        // ===================================================================
        function updatePreview() {
            const f1 = parseInt(document.getElementById('rule1-freq').value) || 2;
            const a1 = parseInt(document.getElementById('rule1-amount').value) || 500;
            const base = 779;
            const p1 = Math.round(base * (0.44 + (f1 === 1 ? 0.1 : 0) + (a1 < 500 ? 0.05 : 0)));
            const p2 = Math.round(base * (0.24 + (a1 > 500 ? 0.05 : 0)));
            document.getElementById('prev1').textContent = Math.max(0, p1);
            document.getElementById('prev2').textContent = Math.max(0, p2);
            document.getElementById('prev3').textContent = Math.max(0, base - p1 - p2);
        }

        let backendData = null;

        async function startProcessing() {
            const file = selectedFile || document.getElementById('fileInput').files[0];
            if (!file) { alert('Please upload a file first'); return; }

            try {
                // Persistent Rules: Save to Firestore before processing
                if (typeof currentUser !== 'undefined' && currentUser && typeof db !== 'undefined') {
                    db.collection('users').doc(currentUser.uid).collection('rules').doc('categorization').set({
                        rule1Freq: parseInt(document.getElementById('rule1-freq').value) || 2,
                        rule1Amount: parseInt(document.getElementById('rule1-amount').value) || 500,
                        rule1Cat: document.getElementById('rule1-cat').value,
                        rule2Freq: parseInt(document.getElementById('rule2-freq').value) || 2,
                        rule2Amount: parseInt(document.getElementById('rule2-amount').value) || 500,
                        rule2Cat: document.getElementById('rule2-cat').value,
                        rule3Cat: document.getElementById('rule3-cat').value,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }).then(() => console.log("Smart Rules synced to cloud"))
                        .catch(e => console.error("Error syncing rules:", e));
                }

                showScreen('processing');

                const pw = document.getElementById('pdfPassword').value;
                const formData = new FormData();
                formData.append('file', file);
                if (pw) formData.append('password', pw);

                // Start the animation immediately for UX
                runProcessingSimulation();

                // Call the actual backend - use absolute URL if needed, but local relative is better in some setups
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(errText || response.statusText);
                }

                const json = await response.json();
                backendData = json;
                console.log("Analysis Complete:", backendData);

            } catch (err) {
                console.error("Processing failed:", err);
                alert("⚠️ Processing Error: " + err.message + "\n\nMake sure the backend server (main.py) is running.");
                showScreen('upload');
            }
        }

        // ===================================================================
        // PROCESSING SIMULATION
        // ===================================================================
        function runProcessingSimulation() {
            const stages = [
                { step: 1, pct: 20, text: 'Stage 1: Extracting raw PDF text...', t: { T: 2715, C: 5, M: 0 } },
                { step: 2, pct: 40, text: 'Stage 2: Identifying transaction types...', t: { T: 0, C: 0, M: 0 } },
                { step: 3, pct: 60, text: 'Stage 3: Applying keyword categorization...', t: { T: 0, C: 0, M: 0 } },
                { step: 4, pct: 80, text: 'Stage 4: Applying Smart Money Rules...', t: { T: 0, C: 0, M: 0 } },
                { step: 5, pct: 100, text: 'Stage 5: Finalizing analytics...', t: { T: 0, C: 0, M: 0 } },
            ];
            let i = 0;
            const run = setInterval(() => {
                if (i >= stages.length) {
                    clearInterval(run);
                    if (!backendData) {
                        document.getElementById('progText').textContent = 'Waiting for backend analysis...';
                        const waiter = setInterval(() => {
                            if (backendData) {
                                clearInterval(waiter);
                                finalizeProcessing();
                            }
                        }, 200);
                        return;
                    }
                    finalizeProcessing();
                    return;
                }

                // If backend data is ALREADY here, we can speed up the later stages
                if (backendData && i > 1) {
                    // Logic to jump steps or just proceed faster
                }

                const s = stages[i];
                document.getElementById('progFill').style.width = s.pct + '%';
                document.getElementById('progText').textContent = s.text;

                const totalTx = backendData ? backendData.summary.total_transactions : 2715;
                const consTx = backendData ? backendData.summary.consumption_transactions : 779;
                const mercCount = (typeof merchants !== 'undefined' ? merchants.length : 5);

                document.getElementById('sT').textContent = totalTx.toLocaleString();
                document.getElementById('sC').textContent = consTx.toLocaleString();
                document.getElementById('sM').textContent = (i > 1 ? mercCount : 0);

                for (let j = 1; j <= s.step; j++) {
                    const el = document.getElementById('ps' + j);
                    if (el) {
                        el.classList.add('done');
                        el.querySelector('.p-circle').textContent = '✓';
                    }
                }
                if (s.step < 5) {
                    const nextEl = document.getElementById('ps' + (s.step + 1));
                    if (nextEl) nextEl.classList.add('active');
                }
                i++;
            }, 700);
        }

        async function finalizeProcessing() {
            if (!backendData) {
                console.error("finalizeProcessing called but no backendData found.");
                showScreen('upload');
                return;
            }

            console.log("Finalizing processing with data:", backendData);

            try {
                // Transform backend data to periodData format
                const s = backendData.summary;
                const p = backendData.period;

                // Calculate Essential vs Discretionary breakdown
                const essCats = ['Bills', 'Transport', 'Groceries', 'Shopping', 'Airtime', 'Government Bills', 'Food & Dining', 'Health Care'];
                const discCats = ['Contribution', 'Subscriptions', 'Personal Care', 'Betting', 'Fast Foods'];

                const catDict = backendData.charts.category_spend;
                const breakdown = [];
                let essentialTotal = 0;
                let discretionaryTotal = 0;
                let otherTotal = 0;

                for (const cat in catDict) {
                    const amount = catDict[cat];
                    if (essCats.includes(cat)) {
                        essentialTotal += amount;
                        breakdown.push({ cat, amount, color: '#27ae60' });
                    } else if (discCats.includes(cat)) {
                        discretionaryTotal += amount;
                        breakdown.push({ cat, amount, color: '#e74c3c' });
                    } else {
                        otherTotal += amount;
                        breakdown.push({ cat, amount, color: '#94a3b8' });
                    }
                }

                breakdown.sort((a, b) => b.amount - a.amount);

                const mappedData = {
                    label: `Full Statement (${p.start} – ${p.end})`,
                    txns: s.total_transactions,
                    spent: s.consumption_spend_kes,
                    received: s.total_received_kes,
                    savings: s.savings_moved_kes,
                    recs: (backendData.recommendations ? backendData.recommendations.length : 0),
                    months: Object.keys(backendData.charts.monthly_trend || {}),
                    trend: Object.values(backendData.charts.monthly_trend || {}),
                    income: Object.values(backendData.charts.income_trend || {}),
                    catData: Object.values(backendData.charts.category_spend || {}),
                    catLabels: Object.keys(backendData.charts.category_spend || {}),
                    essLabels: breakdown.map(x => x.cat),
                    essData: breakdown.map(x => x.amount),
                    essColors: breakdown.map(x => x.color),
                    essSummary: [essentialTotal, discretionaryTotal, otherTotal],
                    savData: backendData.charts.weekly_spend || [s.fees_total_kes, 12000, s.savings_moved_kes],
                    hhi: (s.total_transactions > 0 ? (1 / Math.sqrt(s.total_transactions)).toFixed(3) : '0.110'),
                    recurring: '75%',
                    essential: ((essentialTotal / (s.consumption_spend_kes || 1)) * 100).toFixed(1) + '%',
                    avgTxn: 'KES ' + (s.consumption_spend_kes / (s.consumption_transactions || 1)).toFixed(2),
                    annualSavings: `Total savings moved: KES ${formatAmount(s.savings_moved_kes)}`,
                    recommendations: (backendData.recommendations || []).map(r => ({
                        title: r.message,
                        badge: r.priority === 1 ? 'Critical' : 'High Priority',
                        badgeClass: r.priority === 1 ? 'badge-crit' : 'badge-hi',
                        detail: `<strong>Category:</strong> ${r.category}<br><strong>Current:</strong> ${r.current}<br><strong>Target:</strong> ${r.target}`,
                        impact: r.impact,
                        btn1: { label: 'Action Now', dir: 'optimize' },
                        btn2: { label: 'Explore', dir: 'learn-fees' }
                    }))
                };

                periodData.all = mappedData;

                // --- 1. Firestore Updates (Async/Await) ---
                if (typeof currentUser !== 'undefined' && currentUser && typeof db !== 'undefined') {
                    try {
                        const today = new Date();
                        const options = { day: 'numeric', month: 'short', year: 'numeric' };
                        const lastUploadDate = today.toLocaleDateString('en-GB', options);

                        await db.collection('users').doc(currentUser.uid).set({
                            analyzedCount: firebase.firestore.FieldValue.increment(1),
                            lastUpload: lastUploadDate
                        }, { merge: true });

                        const doc = await db.collection('users').doc(currentUser.uid).get();
                        if (doc.exists) {
                            const data = doc.data();
                            if (document.getElementById('statAnalyzed')) document.getElementById('statAnalyzed').textContent = data.analyzedCount;
                            if (document.getElementById('statLastUpload')) document.getElementById('statLastUpload').textContent = data.lastUpload;
                        }

                        await db.collection('users').doc(currentUser.uid).collection('history').add({
                            fileName: 'M-Pesa Statement (uploaded)',
                            totalSpent: mappedData.spent,
                            totalReceived: mappedData.received,
                            estimatedSavings: mappedData.savings,
                            transactionCount: mappedData.txns,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        console.log("Firestore sync complete.");
                    } catch (fe) {
                        console.warn("Firestore update partially failed:", fe);
                    }
                }

                // --- 2. Chart Updates ---
                if (typeof chartsInited !== 'undefined' && chartsInited) {
                    try {
                        if (window.catChartRef) {
                            window.catChartRef.data.labels = mappedData.catLabels;
                            window.catChartRef.data.datasets[0].data = mappedData.catData;
                            window.catChartRef.update();
                        }
                        if (window.trendChartRef) {
                            window.trendChartRef.data.labels = mappedData.months;
                            window.trendChartRef.data.datasets[0].data = mappedData.trend;
                            if (mappedData.income) {
                                if (!window.trendChartRef.data.datasets[1]) {
                                    window.trendChartRef.data.datasets.push({
                                        label: 'Income', data: mappedData.income, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.05)', tension: 0.4, fill: true
                                    });
                                } else {
                                    window.trendChartRef.data.datasets[1].data = mappedData.income;
                                }
                            }
                            window.trendChartRef.update();
                        }
                        if (window.essChartRef) {
                            window.essChartRef.data.labels = mappedData.essLabels;
                            window.essChartRef.data.datasets[0].data = mappedData.essData;
                            window.essChartRef.data.datasets[0].backgroundColor = mappedData.essColors;
                            window.essChartRef.update();
                        }
                        if (window.savChartRef) {
                            window.savChartRef.data.datasets[0].data = mappedData.savData;
                            window.savChartRef.update();
                        }
                        console.log("Charts synced.");
                    } catch (ce) {
                        console.warn("Chart sync failed:", ce);
                    }
                }

                // --- 3. ML Status Update ---
                try {
                    const dot = document.getElementById('mlStatusDot');
                    const txt = document.getElementById('mlStatusText');
                    if (dot && txt) {
                        if (backendData.ml_models_saved) {
                            dot.style.background = '#10b981';
                            const meta = backendData.ml_model_metadata;
                            if (meta && meta.metrics && meta.selected_model) {
                                const r2 = meta.metrics[meta.selected_model].test_r2;
                                txt.textContent = `ML Model: Active (${meta.selected_model} R²=${r2})`;
                            } else {
                                txt.textContent = 'ML Model: Active';
                            }
                        } else {
                            dot.style.background = '#f59e0b';
                            txt.textContent = 'ML Model: Basic (Rule-only)';
                        }
                    }
                } catch (me) {
                    console.warn("ML status update failed:", me);
                }

                // Final transition
                setTimeout(() => {
                    showScreen('learning');
                    if (typeof renderMerchant === 'function') renderMerchant();
                }, 600);

            } catch (err) {
                console.error("Critical error in finalizeProcessing:", err);
                alert("An error occurred while finishing the analysis. Check console for details.");
                showScreen('upload');
            }
        }

        // ===================================================================
        // MERCHANT LEARNER
        // ===================================================================
        const merchants = [
            { id: 'T5160944', name: 'Merchant Payment to 5160944 — LIMURU RONGAI SUPERMARKET', count: 12, amounts: [500, 1200, 800, 600, 450, 750, 900, 550, 650, 1100, 480, 720] },
            { id: 'P0722123456', name: 'Customer Payment — MARY WANJIRU', count: 8, amounts: [300, 300, 350, 280, 320, 290, 310, 340] },
            { id: 'T7798896', name: 'Merchant Payment to 7798896 — DAVID MUIRURI KAHUKI', count: 5, amounts: [2000, 1500, 1800, 2200, 1600] },
            { id: 'P0733445566', name: 'Customer Transfer — JOHN KAMAU', count: 3, amounts: [5000, 4500, 5500] },
            { id: 'T6617707', name: 'Merchant Payment to 6617707 — AMANI SHOP KINYOZI', count: 4, amounts: [200, 250, 200, 300] },
        ];
        let mIdx = 0;
        const categories = ['🚌 Transport', '🥬 Groceries', '🛒 Shopping', '🍽️ Food & Dining', '🔨 Construction', '👥 Friends & Family', '🎉 Entertainment', '💇 Personal Care'];

        function renderMerchant() {
            const container = document.getElementById('merchantsList');
            if (mIdx >= merchants.length) {
                showScreen('dashboard');
                document.getElementById('navLinks').style.display = 'flex';
                document.getElementById('userInfo').style.display = 'flex';
                setTimeout(() => { initCharts(); }, 120);
                return;
            }
            const m = merchants[mIdx];
            document.getElementById('lProgress').textContent = mIdx + '/' + merchants.length;
            document.getElementById('lRemain').textContent = merchants.length - mIdx;

            const mn = Math.min(...m.amounts), mx = Math.max(...m.amounts);
            const avg = Math.round(m.amounts.reduce((a, b) => a + b, 0) / m.amounts.length);
            const tot = m.amounts.reduce((a, b) => a + b, 0);

            container.innerHTML = `
            <div class="merchant-card">
                <div class="merchant-name">${m.name}</div>
                <div class="merchant-meta">Appears <strong>${m.count}</strong> times in this statement</div>
                <div class="amounts-box">
                    <div class="amounts-grid">
                        <div class="amount-cell"><div class="amount-cell-label">Min</div><div class="amount-cell-value">KES ${mn.toLocaleString()}</div></div>
                        <div class="amount-cell"><div class="amount-cell-label">Max</div><div class="amount-cell-value">KES ${mx.toLocaleString()}</div></div>
                        <div class="amount-cell"><div class="amount-cell-label">Average</div><div class="amount-cell-value">KES ${avg.toLocaleString()}</div></div>
                        <div class="amount-cell"><div class="amount-cell-label">Total</div><div class="amount-cell-value">KES ${tot.toLocaleString()}</div></div>
                    </div>
                    <div class="amount-range">Range: KES ${mn.toLocaleString()} – KES ${mx.toLocaleString()}</div>
                </div>
                <div class="cat-label">What category is this?</div>
                <div class="cat-grid" id="catGrid">
                    ${categories.map(c => `<div class="cat-btn" data-cat="${c}">${c}</div>`).join('')}
                </div>
                <div class="learn-actions">
                    <button class="btn btn-secondary" onclick="skipMerchant()">Skip</button>
                    <button class="btn btn-primary" id="saveM" disabled onclick="saveMerchant()">Save & Next →</button>
                </div>
            </div>`;

            let selCat = null;
            document.querySelectorAll('.cat-btn').forEach(b => {
                b.addEventListener('click', function () {
                    document.querySelectorAll('.cat-btn').forEach(x => x.classList.remove('selected'));
                    this.classList.add('selected');
                    selCat = this.dataset.cat;
                    document.getElementById('saveM').disabled = false;
                });
            });
            window._getSelCat = () => selCat;
        }
        function saveMerchant() {
            const cat = window._getSelCat();
            if (cat && typeof currentUser !== 'undefined' && currentUser) {
                const m = merchants[mIdx];

                // Persistent learning in Firestore
                db.collection('users').doc(currentUser.uid)
                    .collection('merchants').doc(m.id).set({
                        name: m.name,
                        category: cat,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }).then(() => {
                        console.log("Learned merchant: " + m.name);
                    }).catch(err => console.error("Error learning merchant:", err));

                mIdx++;
                renderMerchant();
            }
        }
        function skipMerchant() { mIdx++; renderMerchant(); }

        // ===================================================================
        // DASHBOARD TABS
        // ===================================================================
        function switchTab(id, btn) {
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('panel' + id.charAt(0).toUpperCase() + id.slice(1)).classList.add('active');
            btn.classList.add('active');
            if (id === 'ana') setTimeout(initCharts, 80);
        }

        // ===================================================================
        // DASHBOARD RULES
        // ===================================================================
        // ===================================================================
        // PERIOD FILTER
        // ===================================================================
        var periodData = {
            all: {
                label: 'All Time (Feb 2024 – Feb 2026)',
                txns: 2715, spent: 186000, received: 54000, savings: 37000, recs: 3,
                months: ["Sep '25", "Oct '25", "Nov '25", "Dec '25", "Jan '26", "Feb '26"],
                trend: [14877, 7400, 5920, 12335, 10085, 2239],
                income: [15000, 8000, 10000, 13000, 11000, 5000],
                catData: [34182, 29075, 21475, 21149, 21031, 11877, 10244, 8178, 4493, 4361],
                essLabels: ['Bills', 'Transport', 'Groceries', 'Shopping', 'Airtime', 'Gov Bills', 'Contribution', 'Subscriptions'],
                essData: [115000, 112000, 104000, 46000, 45000, 32000, 80000, 46000],
                essColors: ['#27ae60', '#27ae60', '#27ae60', '#27ae60', '#27ae60', '#27ae60', '#e74c3c', '#e74c3c'],
                savData: [1024000, 700000, 750000, 450000, 280000],
                hhi: '0.108', recurring: '77.6%', essential: '75.6%', avgTxn: 'KES 118.80',
                annualSavings: 'KES 37,166/month = KES 445,992/year',
                recommendations: [
                    {
                        title: 'URGENT: Reduce M-Pesa Transaction Fees',
                        badge: 'Critical', badgeClass: 'badge-crit',
                        detail: '<strong>Current:</strong> KES 21,475 in M-Pesa fees (779 transactions)<br><strong>Action:</strong> Consolidate transactions, use free channels',
                        impact: '💰 Save KES 6,443/month · KES 77,316/year',
                        btn1: { label: 'Set Up Optimization', dir: 'optimize' },
                        btn2: { label: 'Learn More', dir: 'learn-fees' }
                    },
                    {
                        title: 'Eliminate Budget Leaks',
                        badge: 'High Priority', badgeClass: 'badge-hi',
                        detail: '<strong>Issue:</strong> KES 60,173 in small frequent expenses<br><strong>Categories:</strong> M-Pesa fees, Food &amp; Dining, Transport',
                        impact: '💡 Save KES 12,035/month by tracking small purchases',
                        btn1: { label: 'Set Daily Limit', dir: 'budget-limit' },
                        btn2: { label: 'View Details', dir: 'learn-leaks' }
                    },
                    {
                        title: 'Fix Negative Cash Flow',
                        badge: 'Critical', badgeClass: 'badge-crit',
                        detail: '<strong>Problem:</strong> Expenses exceed income by 241%<br><strong>Action:</strong> Immediate spending review required',
                        impact: '⚠️ Unsustainable — need immediate action',
                        btn1: { label: 'Create Action Plan', dir: 'action-plan' },
                        btn2: { label: 'See Breakdown', dir: 'learn-cashflow' }
                    }
                ]
            },
            thisyear: {
                label: 'This Year (2026)',
                txns: 312, spent: 16000, received: 8000, savings: 4000, recs: 2,
                months: ["Jan '26", "Feb '26"],
                trend: [10085, 2239],
                income: [11000, 5000],
                catData: [5200, 4100, 2800, 3100, 2900, 1500, 1200, 900, 600, 500],
                essLabels: ['Bills', 'Transport', 'Groceries', 'Shopping', 'Airtime', 'Gov Bills', 'Contribution', 'Subscriptions'],
                essData: [8000, 7200, 6500, 3100, 2900, 1500, 5200, 3100],
                essColors: ['#27ae60', '#27ae60', '#27ae60', '#27ae60', '#27ae60', '#27ae60', '#e74c3c', '#e74c3c'],
                savData: [110000, 75000, 80000, 48000, 30000],
                hhi: '0.121', recurring: '72.4%', essential: '70.2%', avgTxn: 'KES 102.30',
                annualSavings: 'KES 4,000/month = KES 48,000 projected',
                recommendations: [
                    {
                        title: 'High Spending in January — Review Festive Carry-Over',
                        badge: 'High Priority', badgeClass: 'badge-hi',
                        detail: '<strong>January spend:</strong> KES 10,085 — 4.5× higher than Feb<br><strong>Action:</strong> Set a post-festive budget reset for Q1',
                        impact: '💡 Save KES 2,500/month by smoothing seasonal spikes',
                        btn1: { label: 'Set Monthly Budget', dir: 'budget-limit' },
                        btn2: { label: 'View Breakdown', dir: 'learn-leaks' }
                    },
                    {
                        title: 'Reduce M-Pesa Transaction Fees',
                        badge: 'Medium', badgeClass: 'badge-hi',
                        detail: '<strong>Fees so far this year:</strong> KES 2,800 (2 months)<br><strong>Projected annual:</strong> KES 16,800',
                        impact: '💰 Save KES 820/month on fees alone',
                        btn1: { label: 'Set Up Optimization', dir: 'optimize' },
                        btn2: { label: 'Learn More', dir: 'learn-fees' }
                    }
                ]
            },
            lastyear: {
                label: 'Last Year (2025)',
                txns: 1820, spent: 124000, received: 38000, savings: 25000, recs: 3,
                months: ["Jan '25", "Apr '25", "Jul '25", "Oct '25", "Dec '25"],
                trend: [9200, 11400, 8800, 7400, 12335],
                income: [9500, 11500, 9000, 8000, 13000],
                catData: [22000, 18500, 14200, 13800, 14100, 8000, 6900, 5400, 3100, 2800],
                essLabels: ['Bills', 'Transport', 'Groceries', 'Shopping', 'Airtime', 'Gov Bills', 'Contribution', 'Subscriptions'],
                essData: [62000, 58000, 54000, 22000, 18500, 14200, 45000, 28000],
                essColors: ['#27ae60', '#27ae60', '#27ae60', '#27ae60', '#27ae60', '#27ae60', '#e74c3c', '#e74c3c'],
                savData: [820000, 560000, 600000, 360000, 224000],
                hhi: '0.112', recurring: '79.1%', essential: '74.8%', avgTxn: 'KES 115.20',
                annualSavings: 'KES 25,000/month = KES 300,000/year',
                recommendations: [
                    {
                        title: 'December Spending Spike — Festive Overspend',
                        badge: 'Critical', badgeClass: 'badge-crit',
                        detail: '<strong>December 2025:</strong> KES 12,335 — highest single month of the year<br><strong>Action:</strong> Set a December cap budget for 2026',
                        impact: '⚠️ Festive spikes account for 9.9% of your annual spend',
                        btn1: { label: 'Create Action Plan', dir: 'action-plan' },
                        btn2: { label: 'See Breakdown', dir: 'learn-cashflow' }
                    },
                    {
                        title: 'M-Pesa Fees — Full Year Cost',
                        badge: 'High Priority', badgeClass: 'badge-hi',
                        detail: '<strong>2025 total fees:</strong> KES 14,200 across 512 transactions<br><strong>Action:</strong> Switch recurring payments to free channels',
                        impact: '💰 Save KES 4,100/month by consolidating transactions',
                        btn1: { label: 'Set Up Optimization', dir: 'optimize' },
                        btn2: { label: 'Learn More', dir: 'learn-fees' }
                    },
                    {
                        title: 'Strong Recurring Pattern — Automate Your Savings',
                        badge: 'Opportunity', badgeClass: 'badge-hi',
                        detail: '<strong>79.1% recurring transactions</strong> — your habits are stable<br><strong>Action:</strong> Add automated savings to your routine',
                        impact: '📈 Turn habit into wealth — automate KES 5,000/month',
                        btn1: { label: 'Set Up Savings', dir: 'budget-limit' },
                        btn2: { label: 'View Insights', dir: 'learn-leaks' }
                    }
                ]
            },
            '6m': {
                label: 'Last 6 Months (Sep 2025 – Feb 2026)',
                txns: 890, spent: 61000, received: 18000, savings: 12000, recs: 3,
                months: ["Sep '25", "Oct '25", "Nov '25", "Dec '25", "Jan '26", "Feb '26"],
                trend: [14877, 7400, 5920, 12335, 10085, 2239],
                income: [15000, 8000, 10000, 13000, 11000, 5000],
                catData: [14000, 11500, 8800, 8400, 8200, 4800, 3900, 3100, 1800, 1600],
                essLabels: ['Bills', 'Transport', 'Groceries', 'Shopping', 'Airtime', 'Gov Bills', 'Contribution', 'Subscriptions'],
                essData: [32000, 28000, 26000, 11500, 11200, 8400, 24000, 14000],
                essColors: ['#27ae60', '#27ae60', '#27ae60', '#27ae60', '#27ae60', '#27ae60', '#e74c3c', '#e74c3c'],
                savData: [400000, 280000, 300000, 180000, 112000],
                hhi: '0.115', recurring: '76.3%', essential: '74.1%', avgTxn: 'KES 110.50',
                annualSavings: 'KES 12,000/month = KES 144,000 projected',
                recommendations: [
                    {
                        title: 'Volatile Spending — Sep & Dec Spikes',
                        badge: 'High Priority', badgeClass: 'badge-hi',
                        detail: '<strong>Sep 2025:</strong> KES 14,877 vs <strong>Nov:</strong> KES 5,920<br><strong>Action:</strong> Smooth monthly spending with a rolling budget',
                        impact: '💡 Reducing variance could free KES 3,000/month',
                        btn1: { label: 'Set Monthly Budget', dir: 'budget-limit' },
                        btn2: { label: 'See Pattern', dir: 'learn-leaks' }
                    },
                    {
                        title: 'Reduce M-Pesa Transaction Fees',
                        badge: 'Critical', badgeClass: 'badge-crit',
                        detail: '<strong>Last 6 months fees:</strong> KES 8,800 across 318 transactions<br><strong>Action:</strong> Consolidate and use free alternatives',
                        impact: '💰 Save KES 2,800/month on fees',
                        btn1: { label: 'Set Up Optimization', dir: 'optimize' },
                        btn2: { label: 'Learn More', dir: 'learn-fees' }
                    },
                    {
                        title: 'Negative Cash Flow Trend Continues',
                        badge: 'Critical', badgeClass: 'badge-crit',
                        detail: '<strong>Spent:</strong> KES 61K vs <strong>Received:</strong> KES 18K (–KES 43K)<br><strong>Action:</strong> Immediate income or expense review needed',
                        impact: '⚠️ Deficit of KES 43K over 6 months — unsustainable',
                        btn1: { label: 'Create Action Plan', dir: 'action-plan' },
                        btn2: { label: 'See Breakdown', dir: 'learn-cashflow' }
                    }
                ]
            },
            '3m': {
                label: 'Last 3 Months (Dec 2025 – Feb 2026)',
                txns: 440, spent: 24700, received: 16000, savings: 5000, recs: 2,
                months: ["Dec '25", "Jan '26", "Feb '26"],
                trend: [12335, 10085, 2239],
                income: [13000, 11000, 5000],
                catData: [6200, 5800, 4100, 3100, 2400, 1200, 900, 500, 300, 200],
                essLabels: ['Bills', 'Transport', 'Groceries', 'Shopping', 'Airtime', 'Gov Bills', 'Contribution', 'Subscriptions'],
                essData: [12500, 11200, 9400, 5800, 3600, 1800, 11000, 5400],
                essColors: ['#27ae60', '#27ae60', '#27ae60', '#27ae60', '#27ae60', '#27ae60', '#e74c3c', '#e74c3c'],
                savData: [260000, 185000, 140000, 92000, 48000],
                hhi: '0.125', recurring: '74.2%', essential: '71.5%', avgTxn: 'KES 108.40',
                annualSavings: 'KES 5,000/month = KES 60,000 projected',
                recommendations: [
                    {
                        title: 'Cash Flow Warning — Feb Deficit',
                        badge: 'Critical', badgeClass: 'badge-crit',
                        detail: '<strong>Feb 2026:</strong> Spent KES 2,239 vs Income KES 5,000<br><strong>Note:</strong> Though technically a surplus, your low transaction volume suggests income delay',
                        impact: '⚠️ Surplus of KES 2,761 — buffer for next month',
                        btn1: { label: 'View Breakdown', dir: 'learn-cashflow' },
                        btn2: { label: 'See Patterns', dir: 'learn-leaks' }
                    },
                    {
                        title: 'High Dec Spending — Impact 11.2% of Q4',
                        badge: 'High Priority', badgeClass: 'badge-hi',
                        detail: '<strong>Dec 2025 spent:</strong> KES 12,335<br><strong>Action:</strong> Set holiday buffer from Oct',
                        impact: '💡 Save KES 1,800/month by spreading festive costs',
                        btn1: { label: 'Set Up Buffer', dir: 'budget-limit' },
                        btn2: { label: 'Explore', dir: 'learn-leaks' }
                    }
                ]
            },
            '1m': {
                label: 'This Month (Feb 2026)',
                txns: 82, spent: 2239, received: 5000, savings: 1500, recs: 1,
                months: ["Feb '26"],
                trend: [2239],
                income: [5000],
                catData: [800, 500, 300, 200, 150, 110, 80, 50, 30, 20],
                essLabels: ['Bills', 'Transport', 'Groceries', 'Shopping', 'Airtime', 'Gov Bills', 'Contribution', 'Subscriptions'],
                essData: [1100, 800, 650, 400, 280, 110, 500, 200],
                essColors: ['#27ae60', '#27ae60', '#27ae60', '#27ae60', '#27ae60', '#27ae60', '#e74c3c', '#e74c3c'],
                savData: [42000, 28000, 12000, 8000, 4000],
                hhi: '0.145', recurring: '68.4%', essential: '65.2%', avgTxn: 'KES 27.30',
                annualSavings: 'KES 1,500/month = KES 18,000 projected',
                recommendations: [
                    {
                        title: 'Surplus Opportunity',
                        badge: 'Positive', badgeClass: 'badge-hi',
                        detail: '<strong>Received:</strong> KES 5,000 vs <strong>Spent:</strong> KES 2,239<br><strong>Action:</strong> Save the surplus KES 2,761 immediately',
                        impact: '📈 Accelerate goals by 15%',
                        btn1: { label: 'Move to Savings', dir: 'budget-limit' },
                        btn2: { label: 'View Insights', dir: 'learn-leaks' }
                    }
                ]
            }
        };

        let activePeriodKey = 'all';

        function setPeriod(key, btn) {
            activePeriodKey = key;
            document.querySelectorAll('.period-chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('filterMonth').value = '';
            document.getElementById('filterYear').value = '';
            document.getElementById('rangePicker').style.display = 'none';
            document.querySelector('.period-range-btn').classList.remove('open');
            applyPeriod(periodData[key]);
        }

        function applyMonthFilter() {
            const m = document.getElementById('filterMonth').value;
            const y = document.getElementById('filterYear').value;
            if (!m && !y) { setPeriod('all', document.querySelector('.period-chip')); return; }
            document.querySelectorAll('.period-chip').forEach(c => c.classList.remove('active'));
            const date = new Date(y || 2026, (m || 1) - 1, 1);
            const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            let label = m && y ? `${monthNames[+m]} ${y}` : m ? `${monthNames[+m]} (All Years)` : `All of ${y}`;
            const factor = (m && y) ? 0.04 : m ? 0.12 : 0.5;
            const base = periodData.all;
            const spent = Math.round(base.spent * factor);
            const received = Math.round(base.received * factor);
            const savings = Math.round(base.savings * factor);
            applyPeriod(buildDynamic(label, base, factor, spent, received, savings, 1));
        }

        function applyRange() {
            const from = document.getElementById('rangeFrom').value;
            const to = document.getElementById('rangeTo').value;
            if (!from || !to) return;
            document.querySelectorAll('.period-chip').forEach(c => c.classList.remove('active'));
            const fDate = new Date(from), tDate = new Date(to);
            const monthCount = Math.max(1, Math.round((tDate - fDate) / (1000 * 60 * 60 * 24 * 30)));
            const factor = Math.min(1, monthCount / 24);
            const base = periodData.all;
            const fromStr = fDate.toLocaleDateString('en-KE', { month: 'short', year: '2-digit' });
            const toStr = tDate.toLocaleDateString('en-KE', { month: 'short', year: '2-digit' });
            const label = `${fromStr} → ${toStr}`;
            const spent = Math.round(base.spent * factor);
            const received = Math.round(base.received * factor);
            const savings = Math.round(base.savings * factor);
            applyPeriod(buildDynamic(label, base, factor, spent, received, savings, monthCount));
        }

        function buildDynamic(label, base, factor, spentVal, recVal, savVal, monthCount) {
            const deficit = spentVal - recVal;
            return {
                label,
                txns: Math.round(base.txns * factor),
                spent: spentVal, received: recVal, savings: savVal,
                months: base.months.slice(-Math.max(1, Math.min(6, monthCount || Math.round(factor * 6)))),
                trend: base.trend.slice(-Math.max(1, Math.min(6, monthCount || Math.round(factor * 6)))),
                income: base.income ? base.income.slice(-Math.max(1, Math.min(6, monthCount || Math.round(factor * 6)))) : null,
                catData: base.catData.map(v => Math.round(v * factor)),
                essLabels: base.essLabels,
                essData: base.essData.map(v => Math.round(v * factor)),
                essColors: base.essColors,
                savData: base.savData.map(v => Math.round(v * factor)),
                hhi: (0.1 + factor * 0.02).toFixed(3),
                recurring: (70 + factor * 8).toFixed(1) + '%',
                essential: (68 + factor * 8).toFixed(1) + '%',
                avgTxn: 'KES ' + (90 + factor * 30).toFixed(2),
                annualSavings: `KES ${formatAmount(savVal)}/month = KES ${formatAmount(savVal * 12)} projected`,
                recommendations: deficit > 5000 ? [
                    {
                        title: 'Expenses Exceed Income in This Period',
                        badge: 'Critical', badgeClass: 'badge-crit',
                        detail: `<strong>Spent:</strong> KES ${formatAmount(spentVal)} vs <strong>Received:</strong> KES ${formatAmount(recVal)} (–KES ${formatAmount(deficit)})<br><strong>Action:</strong> Review and reduce top spending categories`,
                        impact: `⚠️ Deficit of KES ${formatAmount(deficit)} — create a plan immediately`,
                        btn1: { label: 'Create Action Plan', dir: 'action-plan' },
                        btn2: { label: 'See Breakdown', dir: 'learn-cashflow' }
                    },
                    {
                        title: 'Reduce Transaction Fees in This Period',
                        badge: 'High Priority', badgeClass: 'badge-hi',
                        detail: `<strong>Estimated fees:</strong> KES ${formatAmount(spentVal * 0.115)} in this period<br><strong>Action:</strong> Switch to free channels where possible`,
                        impact: `💰 Estimated saving of KES ${formatAmount(savVal)}/month`,
                        btn1: { label: 'Set Up Optimization', dir: 'optimize' },
                        btn2: { label: 'Learn More', dir: 'learn-fees' }
                    }
                ] : [
                    {
                        title: 'Good Balance This Period — Keep It Up',
                        badge: 'Positive', badgeClass: 'badge-hi',
                        detail: `<strong>Spent:</strong> KES ${formatAmount(spentVal)} vs <strong>Received:</strong> KES ${formatAmount(recVal)}<br><strong>Action:</strong> Channel the surplus into savings`,
                        impact: `📈 Allocate surplus KES ${formatAmount(recVal - spentVal)} to savings goals`,
                        btn1: { label: 'Set Up Savings', dir: 'budget-limit' },
                        btn2: { label: 'View Insights', dir: 'learn-leaks' }
                    }
                ]
            };
        }

        function applyPeriod(data) {
            // ── Summary cards ──
            document.getElementById('sumSpent').textContent = 'KES ' + formatAmount(data.spent);
            document.getElementById('sumReceived').textContent = 'KES ' + formatAmount(data.received);
            document.getElementById('sumSavings').textContent = 'KES ' + formatAmount(data.savings);
            document.getElementById('sumRecs').textContent = data.recommendations.length;
            document.getElementById('sumTxns').textContent = data.txns.toLocaleString() + ' transactions';
            document.getElementById('sumPeriod').textContent = data.label;

            // ── Active filter pill ──
            const af = document.getElementById('activeFilter');
            const isAll = data.label === periodData.all.label;
            document.getElementById('activeFilterText').textContent = '📅 Showing: ' + data.label;
            af.style.display = isAll ? 'none' : 'flex';

            // ── Recommendations ──
            const recPanel = document.getElementById('panelRec');
            recPanel.innerHTML = `<div class="panel-title"><span>🎯</span> Top Recommendations <span style="font-size:0.8rem;font-weight:500;color:var(--muted);margin-left:0.5rem;">· ${data.label}</span></div>`;
            if (data.recommendations.length === 0) {
                recPanel.innerHTML += `<div class="insight-item"><div class="insight-icon">🎉</div><div>No critical recommendations for this period. Keep it up!</div></div>`;
            } else {
                data.recommendations.forEach(r => {
                    recPanel.innerHTML += `
                <div class="rec-item">
                    <div class="rec-top">
                        <div class="rec-title">${r.title}</div>
                        <span class="badge ${r.badgeClass}">${r.badge}</span>
                    </div>
                    <div class="rec-detail">${r.detail}</div>
                    <div class="rec-impact">${r.impact}</div>
                    <div class="rec-btns">
                        <button class="btn btn-primary btn-sm" onclick="openDir('${r.btn1.dir}')">${r.btn1.label}</button>
                        <button class="btn btn-secondary btn-sm" onclick="openDir('${r.btn2.dir}')">${r.btn2.label}</button>
                    </div>
                </div>`;
                });
            }

            // ── Insights ──
            const insPanel = document.getElementById('panelIns');
            insPanel.innerHTML = `
            <div class="panel-title"><span>💡</span> Financial Insights <span style="font-size:0.8rem;font-weight:500;color:var(--muted);margin-left:0.5rem;">· ${data.label}</span></div>
            <div class="insight-item"><div class="insight-icon">📊</div><div><strong>Spending Concentration:</strong> HHI = ${data.hhi} (${parseFloat(data.hhi) < 0.15 ? 'diverse spending — good!' : 'concentrated — consider diversifying'})</div></div>
            <div class="insight-item"><div class="insight-icon">🔄</div><div><strong>Recurring Patterns:</strong> ${data.recurring} of transactions are recurring</div></div>
            <div class="insight-item"><div class="insight-icon">💰</div><div><strong>Essential vs Discretionary:</strong> ${data.essential} essential, ${(100 - parseFloat(data.essential)).toFixed(1)}% discretionary</div></div>
            <div class="insight-item"><div class="insight-icon">📈</div><div><strong>Average Transaction:</strong> ${data.avgTxn} per transaction</div></div>
            <div class="insight-item"><div class="insight-icon">⚡</div><div><strong>Total Potential Savings:</strong> ${data.annualSavings}</div></div>
            <div class="insight-item"><div class="insight-icon">📥</div><div><strong>Total Received:</strong> KES ${data.received} in this period</div></div>
            <div class="insight-item"><div class="insight-icon">📤</div><div><strong>Total Spent:</strong> KES ${data.spent} across ${data.txns.toLocaleString()} transactions</div></div>`;

            // ── Charts ──
            if (chartsInited) {
                if (window.trendChartRef) {
                    window.trendChartRef.data.labels = data.months;
                    window.trendChartRef.data.datasets[0].data = data.trend;
                    if (data.income) {
                        if (!window.trendChartRef.data.datasets[1]) {
                            window.trendChartRef.data.datasets.push({
                                label: 'Income', data: data.income, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.05)', tension: 0.4, fill: true
                            });
                        } else {
                            window.trendChartRef.data.datasets[1].data = data.income;
                        }
                    }
                    window.trendChartRef.update();
                }
                if (window.catChartRef) {
                    if (data.catLabels) window.catChartRef.data.labels = data.catLabels;
                    window.catChartRef.data.datasets[0].data = data.catData;
                    window.catChartRef.update();
                }
                if (window.essChartRef) {
                    window.essChartRef.data.labels = data.essLabels;
                    window.essChartRef.data.datasets[0].data = data.essData;
                    if (data.essColors) window.essChartRef.data.datasets[0].backgroundColor = data.essColors;
                    window.essChartRef.update();
                }
                if (window.savChartRef) {
                    window.savChartRef.data.datasets[0].data = data.savData;
                    window.savChartRef.update();
                }
            }
        }

        function toggleRangePicker() {
            const rp = document.getElementById('rangePicker');
            const btn = document.querySelector('.period-range-btn');
            const open = rp.style.display === 'none';
            rp.style.display = open ? 'block' : 'none';
            btn.classList.toggle('open', open);
        }

        function clearRange() {
            document.getElementById('rangePicker').style.display = 'none';
            document.querySelector('.period-range-btn').classList.remove('open');
            clearAllFilters();
        }

        function clearAllFilters() {
            document.getElementById('filterMonth').value = '';
            document.getElementById('filterYear').value = '';
            document.getElementById('rangePicker').style.display = 'none';
            document.querySelector('.period-range-btn').classList.remove('open');
            document.querySelectorAll('.period-chip').forEach((c, i) => c.classList.toggle('active', i === 0));
            activePeriodKey = 'all';
            applyPeriod(periodData.all);
        }

        // ===================================================================
        // DIRECTORY PAGE
        // ===================================================================
        const dirData = {
            'optimize': {
                title: 'Fee Optimization Tools', sub: 'Reduce M-Pesa fees and transaction costs',
                cards: [
                    { ic: '📦', icl: 'ic-green', title: 'Transaction Bundler', desc: 'Batch small payments into one to reduce fees. Save up to 60% on transaction costs.', tag: 'Popular', tc: 'tag-hot' },
                    { ic: '🏦', icl: 'ic-blue', title: 'Bank Transfer Switcher', desc: 'Identify transactions you can move to free bank transfers or Pesalink.', tag: 'New', tc: 'tag-new' },
                    { ic: '⏰', icl: 'ic-yellow', title: 'Peak Time Avoidance', desc: 'Best times to transact to minimize fees based on your historical patterns.', tag: 'Smart', tc: '' },
                    { ic: '📊', icl: 'ic-purple', title: 'Fee Tracker Dashboard', desc: 'Track monthly fee spend and see projected annual savings.', tag: 'Live', tc: '' },
                    { ic: '🔔', icl: 'ic-teal', title: 'Fee Alerts', desc: 'Get notified when you exceed your daily or weekly fee budget.', tag: 'Alert', tc: '' },
                    { ic: '💳', icl: 'ic-red', title: 'Overdraft Avoidance', desc: 'Predictive alerts to avoid costly overdraft and reversal charges.', tag: 'Critical', tc: 'tag-crit' },
                ]
            },
            'learn-fees': {
                title: 'Understanding M-Pesa Fees', sub: 'Learn how fees work and how to reduce them',
                cards: [
                    { ic: '📚', icl: 'ic-blue', title: 'Fee Structure Guide', desc: "A complete breakdown of M-Pesa's tariff schedule — know exactly what you're paying.", tag: 'Guide', tc: '' },
                    { ic: '🧮', icl: 'ic-yellow', title: 'Fee Calculator', desc: 'Enter any amount and see the exact M-Pesa fee before transacting.', tag: 'Tool', tc: '' },
                    { ic: '📉', icl: 'ic-green', title: 'Your Fee History', desc: 'View your fee spending trend over the past 24 months.', tag: 'Personal', tc: 'tag-new' },
                    { ic: '💡', icl: 'ic-teal', title: 'Free Alternatives', desc: 'Discover free payment channels: Pesalink, bank apps, and more.', tag: 'Tips', tc: '' },
                ]
            },
            'budget-limit': {
                title: 'Set Up Budget Limits', sub: 'Create spending boundaries to stay on track',
                cards: [
                    { ic: '🎯', icl: 'ic-green', title: 'Daily Spending Limit', desc: 'Set a daily cap for discretionary spending with automatic alerts.', tag: 'Popular', tc: 'tag-hot' },
                    { ic: '📅', icl: 'ic-blue', title: 'Monthly Category Budgets', desc: 'Allocate monthly budgets per category — Food, Transport, Entertainment.', tag: 'Recommended', tc: 'tag-new' },
                    { ic: '⚡', icl: 'ic-yellow', title: '50/30/20 Rule Setup', desc: 'Automatically split income: 50% needs, 30% wants, 20% savings.', tag: 'Smart', tc: '' },
                    { ic: '📊', icl: 'ic-purple', title: 'Spending Leaks Report', desc: 'See which categories are draining your wallet with visual breakdown.', tag: 'Insight', tc: '' },
                ]
            },
            'learn-leaks': {
                title: 'Budget Leaks Deep Dive', sub: 'Understand and plug your spending leaks',
                cards: [
                    { ic: '🔍', icl: 'ic-purple', title: 'Leak Detector', desc: 'Identify which recurring small expenses add up to the biggest drain.', tag: 'Analyzer', tc: '' },
                    { ic: '📊', icl: 'ic-green', title: 'Category Breakdown', desc: 'Full drill-down into Food & Dining, Transport, and M-Pesa fees.', tag: 'Detailed', tc: '' },
                    { ic: '🧩', icl: 'ic-blue', title: 'Pattern Recognition', desc: "77.6% of your transactions are recurring — see the full analysis.", tag: 'Smart', tc: 'tag-new' },
                    { ic: '💰', icl: 'ic-yellow', title: 'Savings Simulator', desc: "See how much you'd save cutting each category by 10%, 20%, or 30%.", tag: 'Tool', tc: '' },
                ]
            },
            'action-plan': {
                title: 'Cash Flow Action Plan', sub: 'Steps to fix your negative cash flow immediately',
                cards: [
                    { ic: '🚨', icl: 'ic-red', title: 'Emergency Budget Mode', desc: 'Activate a strict 30-day spending freeze on all non-essential categories.', tag: 'Critical', tc: 'tag-crit' },
                    { ic: '📋', icl: 'ic-yellow', title: '90-Day Recovery Plan', desc: 'A step-by-step financial recovery plan personalized to your data.', tag: 'Plan', tc: 'tag-new' },
                    { ic: '💼', icl: 'ic-blue', title: 'Income Boost Ideas', desc: 'Suggestions to increase income based on your transaction patterns.', tag: 'Growth', tc: '' },
                    { ic: '📉', icl: 'ic-green', title: 'Expense Ranking', desc: 'All expenses ranked by reduction potential — cut the easiest first.', tag: 'Priority', tc: '' },
                ]
            },
            'learn-cashflow': {
                title: 'Cash Flow Breakdown', sub: 'See exactly where your money is going',
                cards: [
                    { ic: '📊', icl: 'ic-blue', title: 'Income vs Expense Chart', desc: 'Your 24-month income vs expense trend — when did it go negative?', tag: 'History', tc: '' },
                    { ic: '🔢', icl: 'ic-purple', title: '241% Deficit Explained', desc: 'Understand the math behind your current 241% overspend ratio.', tag: 'Analysis', tc: '' },
                    { ic: '🏆', icl: 'ic-green', title: 'Best Month Analysis', desc: "See what you did right in your best-performing months.", tag: 'Learn', tc: 'tag-new' },
                    { ic: '💸', icl: 'ic-red', title: 'Top Expense Offenders', desc: 'The top 5 expense categories causing the most cash flow damage.', tag: 'Critical', tc: 'tag-crit' },
                ]
            }
        };

        function openDir(type) {
            const d = dirData[type] || dirData['optimize'];
            document.getElementById('dirTitle').textContent = d.title;
            document.getElementById('dirSub').textContent = d.sub;
            document.getElementById('dirGrid').innerHTML = d.cards.map((c, i) => `
            <div class="dir-card ${i === 0 ? 'featured' : ''}" onclick="openDetail('${type}', ${i})">
                <div class="dir-icon-wrap ${c.icl}">${c.ic}</div>
                <div class="dir-card-title">${c.title}</div>
                <div class="dir-card-desc">${c.desc}</div>
                ${c.tag ? `<span class="dir-tag ${c.tc}">${c.tag}</span>` : ''}
                <div style="margin-top:1rem; font-size:0.8rem; font-weight:700; color:var(--green);">View Details →</div>
            </div>`).join('');
            showScreen('directory');
        }

        // ===================================================================
        // DETAIL PAGE DATA
        // ===================================================================
        const detailData = {
            'optimize': [
                {
                    icon: '📦', color: 'linear-gradient(135deg,#00AA4F,#006B3D)',
                    tag: 'Most Popular', category: 'Fee Optimization',
                    title: 'Transaction Bundler',
                    subtitle: 'Group small M-Pesa payments together and cut your fee bill by up to 60%',
                    stats: [
                        { val: '60%', label: 'Max Fee Reduction' },
                        { val: 'KES 779', label: 'Avg Monthly Saved' },
                        { val: '12 min', label: 'Setup Time' },
                        { val: '779', label: 'Transactions Analysed' }
                    ],
                    what: 'The Transaction Bundler identifies groups of small, frequent payments you make to the same recipient or merchant — then shows you exactly how to combine them into fewer, larger transactions. Since M-Pesa fees are tiered (you pay the same fee whether you send KES 100 or KES 999), bundling 5 small payments into one can cut your fee spend on that group by up to 80%.',
                    how: [
                        { title: 'Analyse your patterns', body: 'We scan your statement for repeated small-amount payments to the same recipient within the same week.' },
                        { title: 'Identify bundle opportunities', body: 'Any group of 3+ transactions under KES 500 to the same payee in 7 days is flagged as a bundling candidate.' },
                        { title: 'See your savings preview', body: 'We calculate exactly how much you would have saved if you had bundled those transactions last month.' },
                        { title: 'Set a bundling reminder', body: 'Get a notification when you\'re about to make a small payment to someone you\'ve paid recently — so you can wait and send together.' },
                        { title: 'Track your progress', body: 'Your fee savings are tracked monthly so you can see the cumulative impact growing over time.' }
                    ],
                    benefits: [
                        { icon: '💰', title: 'Immediate fee savings', body: 'Most users see their M-Pesa fee bill drop within the first month of using the bundler.' },
                        { icon: '🧠', title: 'No behaviour change needed', body: 'You\'re still sending the same money to the same people — just timing it slightly differently.' },
                        { icon: '📊', title: 'Full transparency', body: 'See a before/after breakdown of what you paid vs what you would have paid.' },
                        { icon: '🔔', title: 'Smart reminders', body: 'Opt-in nudges remind you when bundling an upcoming payment would save you money.' }
                    ],
                    faqs: [
                        { q: 'Will this delay payments to people who need money urgently?', a: 'No — bundling is only suggested for non-urgent recurring payments like paying a regular vendor or sending small top-ups. Urgent transfers are never flagged for bundling.' },
                        { q: 'How much could I realistically save?', a: 'Based on your data, you made 779 transactions last year. If just 20% could be bundled, that\'s around KES 8,600 saved in fees annually — with no change to who gets paid.' },
                        { q: 'Does this work for Paybill and Till payments too?', a: 'Yes. Bundling applies to Send Money, Paybill, and Buy Goods transactions where you pay the same number repeatedly.' }
                    ],
                    savings: [
                        { label: 'Send Money Fees', pct: 72, val: 'KES 5,200/yr' },
                        { label: 'Merchant Payments', pct: 48, val: 'KES 2,100/yr' },
                        { label: 'Paybill Transactions', pct: 35, val: 'KES 1,300/yr' }
                    ],
                    related: [
                        { icon: '🏦', icl: 'ic-blue', title: 'Bank Transfer Switcher', desc: 'Move eligible payments to free channels', dir: 'optimize', idx: 1 },
                        { icon: '🔔', icl: 'ic-teal', title: 'Fee Alerts', desc: 'Get notified before high-fee moments', dir: 'optimize', idx: 4 },
                        { icon: '📊', icl: 'ic-purple', title: 'Fee Tracker Dashboard', desc: 'Monitor your monthly fee spend', dir: 'optimize', idx: 3 }
                    ]
                },
                {
                    icon: '🏦', color: 'linear-gradient(135deg,#3b82f6,#1d4ed8)',
                    tag: 'New', category: 'Fee Optimization',
                    title: 'Bank Transfer Switcher',
                    subtitle: 'Move eligible M-Pesa payments to free bank transfers and save KES 3,000+ per year',
                    stats: [
                        { val: '100%', label: 'Pesalink Fee Saving' },
                        { val: 'KES 250', label: 'Avg M-Pesa Fee/Transfer' },
                        { val: '48 hrs', label: 'Setup Time' },
                        { val: '156', label: 'Switchable Transactions' }
                    ],
                    what: 'Many large M-Pesa transactions — especially salary, rent, and supplier payments — can be made through Pesalink or bank mobile apps completely free. The Bank Transfer Switcher analyses your statement to find every transaction where you paid an M-Pesa fee that you didn\'t have to, and guides you through switching those payments to a free channel.',
                    how: [
                        { title: 'Identify high-fee transactions', body: 'We find all Send Money transactions above KES 1,000 where you paid M-Pesa fees — these are the best candidates for switching.' },
                        { title: 'Check if recipient has a bank account', body: 'We flag transactions to individuals who might have Pesalink-enabled accounts (salaried adults, business owners).' },
                        { title: 'Calculate your switching savings', body: 'See exactly how much you would save per transaction and per year by switching each category.' },
                        { title: 'Get step-by-step switching guide', body: 'A simple guide walks you through setting up Pesalink or bank app transfers for each payment type.' },
                        { title: 'Track adoption over time', body: 'See which of your payments have been successfully switched and your cumulative savings.' }
                    ],
                    benefits: [
                        { icon: '🆓', title: 'Zero fees on qualifying transfers', body: 'Pesalink transfers between Kenyan banks are completely free regardless of amount.' },
                        { icon: '🔒', title: 'Just as secure', body: 'Bank-to-bank transfers use the same security infrastructure as M-Pesa — often more so.' },
                        { icon: '⚡', title: 'Instant transfers', body: 'Pesalink transfers settle in real time, just like M-Pesa.' },
                        { icon: '💼', title: 'Great for business payments', body: 'Paying suppliers and employees via bank transfer also creates cleaner financial records.' }
                    ],
                    faqs: [
                        { q: 'What is Pesalink exactly?', a: 'Pesalink is Kenya\'s interbank transfer platform that lets you send money between any Kenyan bank accounts instantly and for free, via your mobile banking app.' },
                        { q: 'What if the recipient doesn\'t have a bank account?', a: 'For recipients without bank accounts, we\'ll suggest other alternatives like M-Pesa Savings (which earns interest) or timing your M-Pesa transfers to minimise fees.' },
                        { q: 'Are there limits on Pesalink transfers?', a: 'Pesalink typically supports transfers up to KES 999,999 per transaction. Daily limits vary by bank but are generally KES 1M or more.' }
                    ],
                    savings: [
                        { label: 'Large Person Transfers', pct: 85, val: 'KES 6,800/yr' },
                        { label: 'Supplier Payments', pct: 60, val: 'KES 3,200/yr' },
                        { label: 'Salary / Allowances', pct: 90, val: 'KES 2,400/yr' }
                    ],
                    related: [
                        { icon: '📦', icl: 'ic-green', title: 'Transaction Bundler', desc: 'Bundle small payments to cut fees', dir: 'optimize', idx: 0 },
                        { icon: '⏰', icl: 'ic-yellow', title: 'Peak Time Avoidance', desc: 'Transact at the cheapest times', dir: 'optimize', idx: 2 },
                        { icon: '💡', icl: 'ic-teal', title: 'Free Alternatives Guide', desc: 'Full list of zero-fee payment channels', dir: 'learn-fees', idx: 3 }
                    ]
                },
                {
                    icon: '⏰', color: 'linear-gradient(135deg,#f59e0b,#d97706)',
                    tag: 'Smart', category: 'Fee Optimization',
                    title: 'Peak Time Avoidance',
                    subtitle: 'Learn when M-Pesa congestion peaks and time your transactions to avoid hidden costs',
                    stats: [
                        { val: '5–8pm', label: 'Peak Fee Hours' },
                        { val: 'KES 420', label: 'Avg Overpaid/Month' },
                        { val: '23%', label: 'Of Txns Avoidable' },
                        { val: '0', label: 'Behaviour Change Cost' }
                    ],
                    what: 'While M-Pesa fees are officially fixed, system congestion during peak hours can lead to failed transactions that still deduct fees, slower confirmation times, and higher reversal rates. Peak Time Avoidance maps your personal transaction history against known high-traffic windows and shows you the optimal times to transact — shifting even a fraction of your payments out of peak hours saves real money.',
                    how: [
                        { title: 'Map your transaction times', body: 'We plot all your M-Pesa transactions by time of day across your full statement history.' },
                        { title: 'Overlay peak traffic data', body: 'We flag the hours (typically 5–8pm and month-end) where M-Pesa system load is highest.' },
                        { title: 'Identify your avoidable peak transactions', body: 'Non-urgent payments made during peak windows are highlighted as easy wins.' },
                        { title: 'Suggest optimal time windows', body: 'For each category of payment, we recommend the best 2-hour window to transact.' },
                        { title: 'Set smart scheduling reminders', body: 'Optional reminders to handle your routine payments during low-traffic windows.' }
                    ],
                    benefits: [
                        { icon: '✅', title: 'Fewer failed transactions', body: 'Off-peak transactions have significantly lower failure rates, avoiding wasted fees on reversals.' },
                        { icon: '⚡', title: 'Faster confirmations', body: 'Transactions during low-traffic hours typically confirm 3–5x faster.' },
                        { icon: '🗓️', title: 'Simple habit shift', body: 'Most peak-hour transactions can be shifted by just 1–2 hours with no real inconvenience.' },
                        { icon: '📊', title: 'Data-backed timing', body: 'Our recommendations are based on your actual historical transaction patterns, not generic advice.' }
                    ],
                    faqs: [
                        { q: 'Do M-Pesa fees actually vary by time of day?', a: 'The posted tariff doesn\'t change, but failed transactions during peak hours still incur partial charges in some cases, and reversal processing can take longer — tying up your float.' },
                        { q: 'What are the quietest times to transact?', a: 'Based on network data, 6–9am and 10pm–midnight are the lowest-traffic windows. Mid-week (Tue–Thu) is also significantly quieter than Fridays and month-end.' },
                        { q: 'What about time-sensitive payments?', a: 'We only flag non-urgent, discretionary payments for timing optimization. Rent, emergency transfers, and time-sensitive bills are never suggested for delay.' }
                    ],
                    savings: [
                        { label: 'Avoided Failed Txn Fees', pct: 55, val: 'KES 2,100/yr' },
                        { label: 'Reversal Fee Avoidance', pct: 40, val: 'KES 900/yr' },
                        { label: 'Float Opportunity Cost', pct: 30, val: 'KES 600/yr' }
                    ],
                    related: [
                        { icon: '📦', icl: 'ic-green', title: 'Transaction Bundler', desc: 'Combine payments to reduce fee count', dir: 'optimize', idx: 0 },
                        { icon: '🔔', icl: 'ic-teal', title: 'Fee Alerts', desc: 'Get warned before costly transactions', dir: 'optimize', idx: 4 },
                        { icon: '📚', icl: 'ic-blue', title: 'Fee Structure Guide', desc: 'Understand the M-Pesa tariff tiers', dir: 'learn-fees', idx: 0 }
                    ]
                },
                {
                    icon: '📊', color: 'linear-gradient(135deg,#8b5cf6,#6d28d9)',
                    tag: 'Live', category: 'Fee Optimization',
                    title: 'Fee Tracker Dashboard',
                    subtitle: 'A live view of every shilling you spend on M-Pesa fees — by month, category, and recipient',
                    stats: [
                        { val: 'KES 21K', label: 'Your Annual Fees' },
                        { val: '779', label: 'Fee Transactions' },
                        { val: 'KES 1,790', label: 'Monthly Average' },
                        { val: 'KES 27.57', label: 'Avg Fee Per Txn' }
                    ],
                    what: 'Most people have no idea how much they spend on M-Pesa fees because each charge is small and forgettable. The Fee Tracker Dashboard aggregates every fee deducted across your entire statement history into one clear view — broken down by month, transaction type, and recipient category. It\'s the first step to understanding and reducing your fee spend.',
                    how: [
                        { title: 'Extract all fee transactions', body: 'We identify every M-Pesa fee charge in your statement — Send Money fees, Merchant fees, Paybill charges, and more.' },
                        { title: 'Categorise by transaction type', body: 'Fees are grouped by the type of payment that triggered them so you can see where they\'re coming from.' },
                        { title: 'Plot your monthly trend', body: 'A month-by-month chart shows whether your fee spend is rising or falling and why.' },
                        { title: 'Benchmark against targets', body: 'We show you what your fees should look like if you optimised — and the gap to close.' },
                        { title: 'Set a monthly fee budget', body: 'Define a maximum monthly fee spend and get alerts if you\'re on track to exceed it.' }
                    ],
                    benefits: [
                        { icon: '👁️', title: 'Invisible costs made visible', body: 'KES 27 here, KES 50 there — the dashboard shows you it added up to KES 21,475 last year.' },
                        { icon: '📉', title: 'See the trend', body: 'Know immediately if your fee spend is getting worse, so you can act before it compounds.' },
                        { icon: '🎯', title: 'Set and hit targets', body: 'Having a fee budget makes it real — users who set a target reduce fees by an average of 34%.' },
                        { icon: '📤', title: 'Share your report', body: 'Export a clean fee report for your records or to share with a financial advisor.' }
                    ],
                    faqs: [
                        { q: 'How does the system know which transactions are fees?', a: 'M-Pesa statements label fee deductions distinctly. We extract these automatically — you don\'t need to categorise them manually.' },
                        { q: 'Can I see fees broken down by the person I was paying?', a: 'Yes — you can drill into any month or category and see exactly which payments incurred the most fees, down to the individual transaction.' },
                        { q: 'What\'s a realistic fee reduction target?', a: 'Based on your current KES 21,475 annual fee spend, a 30% reduction target of KES 6,443 is very achievable with bundling and channel switching alone.' }
                    ],
                    savings: [
                        { label: 'Visibility Alone (avg reduction)', pct: 22, val: 'KES 4,700/yr' },
                        { label: 'With Fee Budget Set', pct: 34, val: 'KES 7,300/yr' },
                        { label: 'Full Optimisation', pct: 60, val: 'KES 12,800/yr' }
                    ],
                    related: [
                        { icon: '📦', icl: 'ic-green', title: 'Transaction Bundler', desc: 'Act on what the tracker shows you', dir: 'optimize', idx: 0 },
                        { icon: '🏦', icl: 'ic-blue', title: 'Bank Transfer Switcher', desc: 'Eliminate fees on large transfers', dir: 'optimize', idx: 1 },
                        { icon: '📉', icl: 'ic-green', title: 'Your Fee History', desc: '24-month fee trend in detail', dir: 'learn-fees', idx: 2 }
                    ]
                },
                {
                    icon: '🔔', color: 'linear-gradient(135deg,#14b8a6,#0f766e)',
                    tag: 'Alert', category: 'Fee Optimization',
                    title: 'Fee Alerts',
                    subtitle: 'Get real-time warnings before you make a transaction that will cost more than it needs to',
                    stats: [
                        { val: '< 1 sec', label: 'Alert Speed' },
                        { val: '89%', label: 'User Action Rate' },
                        { val: 'KES 340', label: 'Avg Saved Per Alert' },
                        { val: '0', label: 'False Positives' }
                    ],
                    what: 'Fee Alerts are proactive nudges that fire before you complete a transaction — warning you when you\'re about to pay more in fees than necessary. They integrate with your spending patterns to know when a payment could be bundled, switched to a free channel, or timed better. Think of it as having a personal financial advisor looking over your shoulder in real time.',
                    how: [
                        { title: 'Connect your M-Pesa usage patterns', body: 'We learn your recurring payment amounts, recipients, and typical timings from your statement history.' },
                        { title: 'Detect bundling opportunities in real time', body: 'When you initiate a small payment to someone you\'ve paid recently, an alert fires immediately.' },
                        { title: 'Suggest alternatives instantly', body: 'The alert doesn\'t just warn you — it shows you the exact alternative (wait 2 days and bundle, or switch to Pesalink) and the fee saving.' },
                        { title: 'Learn your preferences over time', body: 'If you dismiss an alert type repeatedly, we adjust — no annoying repetition for decisions you\'ve made consciously.' },
                        { title: 'Monthly summary of alert savings', body: 'See how much you saved by acting on alerts each month — your personal fee-avoidance score.' }
                    ],
                    benefits: [
                        { icon: '⚡', title: 'In-the-moment savings', body: 'Alerts fire before money leaves your account — the easiest possible moment to change course.' },
                        { icon: '🤝', title: 'Actionable, not just informational', body: 'Every alert comes with a specific action — not just "this costs money" but "here\'s exactly what to do instead."' },
                        { icon: '🧠', title: 'Gets smarter over time', body: 'The more you use it, the more precisely alerts are calibrated to your actual payment patterns.' },
                        { icon: '🔕', title: 'You control the sensitivity', body: 'Set your minimum alert threshold (e.g. only alert when potential saving exceeds KES 50) to avoid noise.' }
                    ],
                    faqs: [
                        { q: 'Does this require integrating with my M-Pesa directly?', a: 'In the current version, alerts are based on patterns learned from your uploaded statements. Future versions will offer real-time M-Pesa integration via API for live alerts.' },
                        { q: 'What if I just want to send money and not be bothered?', a: 'You can set alert frequency — daily digest instead of per-transaction, or turn off specific alert types entirely. You\'re always in control.' },
                        { q: 'How do I receive alerts?', a: 'Alerts are delivered via the app dashboard and optional SMS/email. Push notification support is coming in the next release.' }
                    ],
                    savings: [
                        { label: 'Bundling Alerts Acted On', pct: 65, val: 'KES 5,600/yr' },
                        { label: 'Channel Switch Alerts', pct: 45, val: 'KES 2,900/yr' },
                        { label: 'Peak Time Alerts', pct: 30, val: 'KES 1,200/yr' }
                    ],
                    related: [
                        { icon: '📦', icl: 'ic-green', title: 'Transaction Bundler', desc: 'The action behind the bundling alerts', dir: 'optimize', idx: 0 },
                        { icon: '⏰', icl: 'ic-yellow', title: 'Peak Time Avoidance', desc: 'Understand the timing logic', dir: 'optimize', idx: 2 },
                        { icon: '🎯', icl: 'ic-green', title: 'Daily Spending Limit', desc: 'Pair alerts with a daily budget', dir: 'budget-limit', idx: 0 }
                    ]
                },
                {
                    icon: '💳', color: 'linear-gradient(135deg,#e74c3c,#c0392b)',
                    tag: 'Critical', category: 'Fee Optimization',
                    title: 'Overdraft Avoidance',
                    subtitle: 'Predict and prevent M-Pesa float shortfalls before they lead to failed transactions and reversal fees',
                    stats: [
                        { val: 'KES 85', label: 'Typical Reversal Fee' },
                        { val: '34', label: 'Your Reversals/Year' },
                        { val: 'KES 2,890', label: 'Lost to Reversals' },
                        { val: '94%', label: 'Preventable' }
                    ],
                    what: 'When your M-Pesa balance runs low and a transaction fails, you often still lose money — to reversal fees, to delayed payments that incur penalties elsewhere, and to the time cost of re-initiating failed payments. Overdraft Avoidance analyses your historical float levels alongside your typical payment schedule to warn you before your balance dips below a safe threshold.',
                    how: [
                        { title: 'Model your float patterns', body: 'We map your typical M-Pesa balance trajectory through the month based on historical inflows and outflows.' },
                        { title: 'Identify recurring danger windows', body: 'Find the days when your float consistently drops lowest — usually just before payday or after month-end obligations.' },
                        { title: 'Flag upcoming high-risk payments', body: 'Scheduled or recurring payments that are likely to coincide with low float periods are highlighted in advance.' },
                        { title: 'Suggest float top-up timing', body: 'Get a reminder 48 hours before a predicted low-float window to top up — from bank or agent.' },
                        { title: 'Track reversal history', body: 'See every failed transaction in your history, what it cost you, and whether it was preventable.' }
                    ],
                    benefits: [
                        { icon: '🚫', title: 'Eliminate reversal fees', body: 'Each prevented failed transaction saves the reversal fee plus the time and stress of re-sending.' },
                        { icon: '⏱️', title: 'Never delay important payments', body: 'Landlords, school fees, suppliers — none of them should be held up by an avoidable float issue.' },
                        { icon: '📈', title: 'Maintain financial reliability', body: 'Consistent, on-time payments improve your relationships with recipients and your own financial confidence.' },
                        { icon: '📉', title: 'Reduce secondary costs', body: 'Late payment penalties elsewhere in your finances often trace back to a failed M-Pesa transfer.' }
                    ],
                    faqs: [
                        { q: 'Does M-Pesa charge a fee for failed transactions?', a: 'In most cases, failed M-Pesa transactions are fully reversed without a fee. However, Paybill and some Merchant payments may have partial deductions, and the disruption can cause late fees with the intended recipient.' },
                        { q: 'How accurate are the float predictions?', a: 'Based on your historical patterns, our float model is accurate within ±15% for 85% of users. Accuracy improves significantly after 3+ months of statement history.' },
                        { q: 'What\'s the minimum float I should maintain?', a: 'We recommend keeping at least 20% of your average monthly outflow as a float buffer. Based on your data, that\'s approximately KES 7,440.' }
                    ],
                    savings: [
                        { label: 'Reversal Fees Avoided', pct: 90, val: 'KES 2,600/yr' },
                        { label: 'Late Payment Penalties', pct: 50, val: 'KES 1,400/yr' },
                        { label: 'Re-send Transaction Costs', pct: 70, val: 'KES 890/yr' }
                    ],
                    related: [
                        { icon: '🔔', icl: 'ic-teal', title: 'Fee Alerts', desc: 'Real-time warnings before transactions', dir: 'optimize', idx: 4 },
                        { icon: '🎯', icl: 'ic-green', title: 'Daily Spending Limit', desc: 'Protect your float with daily caps', dir: 'budget-limit', idx: 0 },
                        { icon: '🚨', icl: 'ic-red', title: 'Emergency Budget Mode', desc: 'Full spending freeze when float is critical', dir: 'action-plan', idx: 0 }
                    ]
                }
            ],
            'budget-limit': [
                {
                    icon: '🎯', color: 'linear-gradient(135deg,#00AA4F,#006B3D)',
                    tag: 'Most Popular', category: 'Budget Management',
                    title: 'Daily Spending Limit',
                    subtitle: 'Set a daily cap on discretionary spending and get alerts before you exceed it',
                    stats: [
                        { val: 'KES 495', label: 'Suggested Daily Limit' },
                        { val: '68%', label: 'Users Who Hit Target' },
                        { val: 'KES 6,200', label: 'Avg Monthly Saved' },
                        { val: '30 days', label: 'To New Habit' }
                    ],
                    what: 'A daily spending limit is the single most effective budgeting tool for M-Pesa users because most overspending happens through dozens of small, spontaneous transactions — a bodaboda here, a snack there. By setting a simple daily ceiling on discretionary spend (everything except fixed bills), you create a natural friction that forces small spending decisions to become conscious ones.',
                    how: [
                        { title: 'Analyse your daily spend patterns', body: 'We calculate your average daily discretionary spend from your statement history and suggest a realistic starting limit.' },
                        { title: 'Set your daily ceiling', body: 'Choose your daily limit — we recommend starting at your current average minus 20% for the first month.' },
                        { title: 'Track spend through the day', body: 'As you make transactions, your daily running total is updated in real time against your limit.' },
                        { title: 'Get smart alerts', body: 'At 75% and 100% of your daily limit, you receive an alert — giving you time to pause and decide.' },
                        { title: 'Review your weekly score', body: 'A weekly summary shows how many days you stayed within limit and how much you saved vs your average.' }
                    ],
                    benefits: [
                        { icon: '🛑', title: 'Stop unconscious overspending', body: 'The biggest cause of budget blowouts is small transactions that feel insignificant in the moment. A daily limit makes each one matter.' },
                        { icon: '📊', title: 'Instant feedback loop', body: 'Unlike monthly budgets that only tell you the damage after the fact, a daily limit gives you real-time correction.' },
                        { icon: '💪', title: 'Builds financial discipline', body: 'Studies show that 30 days of daily limit adherence is enough to rewire spending habits permanently.' },
                        { icon: '🎯', title: 'Personalised to your data', body: 'Your limit isn\'t arbitrary — it\'s based on your actual spending history and calibrated to what\'s achievable.' }
                    ],
                    faqs: [
                        { q: 'What counts as "discretionary" spending?', a: 'Discretionary spend excludes rent, school fees, utility bills, and any fixed recurring payments. It includes food & dining, transport, shopping, entertainment, and M-Pesa fees on non-essential transactions.' },
                        { q: 'What happens if I exceed my limit?', a: 'Nothing is blocked — this is about awareness, not control. You get an alert, and the overspend is logged and shown in your weekly review so you can learn from the pattern.' },
                        { q: 'Can I have different limits for different days?', a: 'Yes — you can set a higher weekend limit and a lower weekday limit if your spending patterns differ significantly between work and leisure days.' }
                    ],
                    savings: [
                        { label: 'Food & Dining Reduction', pct: 55, val: 'KES 3,200/yr' },
                        { label: 'Impulse Transport Costs', pct: 40, val: 'KES 2,100/yr' },
                        { label: 'Miscellaneous Small Spend', pct: 65, val: 'KES 4,800/yr' }
                    ],
                    related: [
                        { icon: '📅', icl: 'ic-blue', title: 'Monthly Category Budgets', desc: 'Add category-level detail to your limits', dir: 'budget-limit', idx: 1 },
                        { icon: '⚡', icl: 'ic-yellow', title: '50/30/20 Rule Setup', desc: 'Frame your daily limit within a broader plan', dir: 'budget-limit', idx: 2 },
                        { icon: '🔔', icl: 'ic-teal', title: 'Fee Alerts', desc: 'Pair with alerts to stop fee overspend', dir: 'optimize', idx: 4 }
                    ]
                },
                {
                    icon: '📅', color: 'linear-gradient(135deg,#3b82f6,#1d4ed8)',
                    tag: 'Recommended', category: 'Budget Management',
                    title: 'Monthly Category Budgets',
                    subtitle: 'Allocate your income across spending categories and track how each one performs month by month',
                    stats: [
                        { val: '10', label: 'Categories Tracked' },
                        { val: 'KES 29K', label: 'Food Budget Needed' },
                        { val: 'KES 21K', label: 'Transport Budget' },
                        { val: '3 months', label: 'To Budget Mastery' }
                    ],
                    what: 'Monthly Category Budgets translate your broad spending intention into specific, measurable allocations for each area of your life. Based on your actual M-Pesa transaction history, we pre-populate a realistic starting budget for each category — then let you adjust based on your goals. Every transaction is automatically matched to its category, so your budget tracks itself.',
                    how: [
                        { title: 'Review your category breakdown', body: 'See exactly how much you spent in each category last month — Food & Dining, Transport, M-Pesa Fees, Shopping, and more.' },
                        { title: 'Set targets for each category', body: 'We pre-fill each budget with your 3-month average as a baseline, then you adjust to set your targets.' },
                        { title: 'Transactions auto-categorise', body: 'Every new M-Pesa transaction is matched to its category using the Smart Money Rules you set up, updating your budget in real time.' },
                        { title: 'Track progress through the month', body: 'A colour-coded dashboard shows green (under budget), amber (approaching limit), and red (over budget) for each category.' },
                        { title: 'Month-end review and next month planning', body: 'At month end, see which categories overran and by how much — then carry lessons into next month\'s budgets.' }
                    ],
                    benefits: [
                        { icon: '🗂️', title: 'Clarity by category', body: 'Stop wondering where money went — every shilling is accounted for in a specific bucket.' },
                        { icon: '🔄', title: 'Auto-populates from your data', body: 'No manual entry needed — your transaction history does the heavy lifting.' },
                        { icon: '📊', title: 'Historical comparison', body: 'See each month\'s category performance side by side to spot trends over time.' },
                        { icon: '🎯', title: 'Category-specific savings goals', body: 'Set a savings target for each overspending category and watch it improve month by month.' }
                    ],
                    faqs: [
                        { q: 'What if a transaction covers multiple categories?', a: 'We handle split transactions — for example, a supermarket shop that includes both groceries and household items can be split across two categories manually or automatically.' },
                        { q: 'How do I handle irregular income months?', a: 'You can set budgets as both fixed (KES amount) or percentage-of-income. Percentage-based budgets automatically scale when your income changes month to month.' },
                        { q: 'What\'s the most overspent category for users like me?', a: 'Based on similar M-Pesa profiles, Food & Dining and M-Pesa Fees are consistently the top two overspent categories — and also the two with the highest reduction potential.' }
                    ],
                    savings: [
                        { label: 'Food & Dining vs Target', pct: 48, val: 'KES 7,000/yr' },
                        { label: 'Transport vs Target', pct: 35, val: 'KES 3,700/yr' },
                        { label: 'Shopping vs Target', pct: 42, val: 'KES 4,300/yr' }
                    ],
                    related: [
                        { icon: '🎯', icl: 'ic-green', title: 'Daily Spending Limit', desc: 'Day-level control within category budgets', dir: 'budget-limit', idx: 0 },
                        { icon: '⚡', icl: 'ic-yellow', title: '50/30/20 Rule Setup', desc: 'The framework behind category allocation', dir: 'budget-limit', idx: 2 },
                        { icon: '🔍', icl: 'ic-purple', title: 'Leak Detector', desc: 'Find which categories drain most', dir: 'learn-leaks', idx: 0 }
                    ]
                },
                {
                    icon: '⚡', color: 'linear-gradient(135deg,#f59e0b,#d97706)',
                    tag: 'Smart', category: 'Budget Management',
                    title: '50/30/20 Rule Setup',
                    subtitle: 'Apply the gold-standard personal finance framework to your actual M-Pesa income and spending',
                    stats: [
                        { val: '50%', label: 'Needs (KES 93K)' },
                        { val: '30%', label: 'Wants (KES 56K)' },
                        { val: '20%', label: 'Savings (KES 37K)' },
                        { val: 'KES 186K', label: 'Annual Spend Mapped' }
                    ],
                    what: 'The 50/30/20 rule is the simplest proven personal budgeting framework: 50% of after-tax income goes to needs (rent, food, transport, bills), 30% to wants (entertainment, dining out, shopping), and 20% to savings and debt repayment. We take your actual M-Pesa transaction data and map every category to the right bucket — then show you exactly how far off or on track you are.',
                    how: [
                        { title: 'Calculate your true income', body: 'We identify all money received via M-Pesa (salary, business income, transfers in) to establish your baseline.' },
                        { title: 'Categorise every transaction as Need, Want, or Save', body: 'Using your Smart Money Rules plus our category database, every transaction is automatically bucketed.' },
                        { title: 'Show your current 50/30/20 split', body: 'See your actual current split — for most users it\'s closer to 75/25/0, meaning little to no savings.' },
                        { title: 'Identify the gap to each target', body: 'We show you exactly which categories to reduce and by how much to hit the 50/30/20 target.' },
                        { title: 'Build a transition plan', body: 'A 3-month step-down plan moves you gradually from your current split to the target without shock.' }
                    ],
                    benefits: [
                        { icon: '🏦', title: 'Finally start saving', body: 'The 20% savings allocation is non-negotiable in this framework — it\'s treated as a bill, not an afterthought.' },
                        { icon: '⚖️', title: 'Guilt-free spending', body: 'Once needs and savings are covered, the 30% wants bucket is yours to spend without guilt.' },
                        { icon: '📐', title: 'A framework, not a restriction', body: 'Unlike strict budgets, the 50/30/20 rule gives you freedom within clear guardrails.' },
                        { icon: '📈', title: 'Measurable progress', body: 'Track your split month by month — watching your savings percentage grow is genuinely motivating.' }
                    ],
                    faqs: [
                        { q: 'What if 50% doesn\'t cover my needs?', a: 'If your needs genuinely exceed 50%, we first check if any "needs" are actually discretionary wants. If needs truly are above 50%, the framework adjusts to 60/20/20 as an interim target.' },
                        { q: 'Does this work if my income is irregular?', a: 'Yes — we calculate 50/30/20 on a rolling 3-month average income, smoothing out the variation from commission-based or freelance income.' },
                        { q: 'What counts as "savings" in this framework?', a: 'Savings includes: M-Pesa savings (Lock Savings / M-Shwari), Sacco contributions, chama deposits, stocks/bonds, and direct bank transfers to savings accounts.' }
                    ],
                    savings: [
                        { label: 'Wants Reduction to 30%', pct: 60, val: 'KES 15,000/yr' },
                        { label: 'Needs Optimisation', pct: 25, val: 'KES 8,500/yr' },
                        { label: 'Savings Generated (20%)', pct: 100, val: 'KES 37,200/yr' }
                    ],
                    related: [
                        { icon: '🎯', icl: 'ic-green', title: 'Daily Spending Limit', desc: 'Enforce the Wants bucket daily', dir: 'budget-limit', idx: 0 },
                        { icon: '📅', icl: 'ic-blue', title: 'Monthly Category Budgets', desc: 'Break down each bucket by category', dir: 'budget-limit', idx: 1 },
                        { icon: '📋', icl: 'ic-yellow', title: '90-Day Recovery Plan', desc: 'Get to 50/30/20 in 90 days', dir: 'action-plan', idx: 1 }
                    ]
                },
                {
                    icon: '📊', color: 'linear-gradient(135deg,#8b5cf6,#6d28d9)',
                    tag: 'Insight', category: 'Budget Management',
                    title: 'Spending Leaks Report',
                    subtitle: 'A forensic breakdown of the small, invisible expenses quietly draining your budget every month',
                    stats: [
                        { val: 'KES 60K', label: 'Your Annual Leaks' },
                        { val: '247', label: 'Leak Transactions' },
                        { val: 'KES 244', label: 'Avg Leak Amount' },
                        { val: '32%', label: 'Of Total Spend' }
                    ],
                    what: 'Spending leaks are the recurring small expenses that you\'ve completely stopped noticing — the daily bodaboda that adds up to KES 9,000/year, the weekly impulse purchases that sum to more than your grocery bill, the app subscriptions you forgot you have. The Spending Leaks Report identifies every category of leak in your data, ranks them by total annual impact, and shows you which ones to plug first for the fastest savings.',
                    how: [
                        { title: 'Identify all recurring small transactions', body: 'We flag every transaction under KES 500 that appears 3+ times per month — the definition of a spending leak.' },
                        { title: 'Group by merchant and category', body: 'Leaks are grouped so you can see "I spend KES 4,200/month on 37 small food purchases" as a single insight.' },
                        { title: 'Rank by annual impact', body: 'The top 10 leaks are ranked by their annualised cost — so you can focus on the ones that matter most.' },
                        { title: 'Model reduction scenarios', body: 'Slide a reduction slider: "If I cut this category by 50%, I save KES X per year."' },
                        { title: 'Set a leak budget', body: 'Turn your insights into action by setting a monthly ceiling for each leak category.' }
                    ],
                    benefits: [
                        { icon: '🔍', title: 'See what was invisible', body: 'Most users are shocked by the total — not because any single leak is large, but because there are so many of them.' },
                        { icon: '🎯', title: 'High-impact, low-effort wins', body: 'Plugging a single leak category (e.g. daily coffee or impulse transport) often saves KES 5,000–8,000 per year.' },
                        { icon: '📉', title: 'Prioritised action list', body: 'You don\'t have to fix everything at once — the ranking tells you exactly where to start.' },
                        { icon: '📊', title: 'Monthly progress tracking', body: 'Each month, see if your leaks are shrinking — the trend line is your accountability partner.' }
                    ],
                    faqs: [
                        { q: 'Some of my "leaks" are things I actually want to spend on — is that okay?', a: 'Absolutely. The report doesn\'t tell you to stop spending — it just makes sure the spending is a conscious choice, not an invisible habit. If you love your daily coffee, keep it. At least now you know it costs you KES 7,300/year.' },
                        { q: 'What\'s the biggest leak most people have?', a: 'Across M-Pesa users in our database, M-Pesa fees themselves are the single largest leak — followed by small food & dining purchases and impulse transport (unplanned bodaboda and taxi rides).' },
                        { q: 'How quickly can plugging leaks change my financial picture?', a: 'Plugging your top 3 leaks typically frees up KES 8,000–15,000 per year with minimal lifestyle impact — that\'s a meaningful contribution to savings, school fees, or debt repayment.' }
                    ],
                    savings: [
                        { label: 'Food & Dining Leaks', pct: 55, val: 'KES 8,200/yr' },
                        { label: 'Transport Leaks', pct: 42, val: 'KES 5,600/yr' },
                        { label: 'Subscription & App Leaks', pct: 80, val: 'KES 3,100/yr' }
                    ],
                    related: [
                        { icon: '🎯', icl: 'ic-green', title: 'Daily Spending Limit', desc: 'Cap daily leaks before they accumulate', dir: 'budget-limit', idx: 0 },
                        { icon: '🔍', icl: 'ic-purple', title: 'Leak Detector', desc: 'Drill deeper into each leak category', dir: 'learn-leaks', idx: 0 },
                        { icon: '💰', icl: 'ic-yellow', title: 'Savings Simulator', desc: 'Model the impact of plugging each leak', dir: 'learn-leaks', idx: 3 }
                    ]
                }
            ]
        };

        // Fallback generic detail for cards without specific detail data
        function buildGenericDetail(dirType, cardIdx) {
            const cat = dirData[dirType];
            if (!cat) return null;
            const card = cat.cards[cardIdx];
            if (!card) return null;
            const colors = {
                'ic-green': 'linear-gradient(135deg,#00AA4F,#006B3D)',
                'ic-blue': 'linear-gradient(135deg,#3b82f6,#1d4ed8)',
                'ic-yellow': 'linear-gradient(135deg,#f59e0b,#d97706)',
                'ic-purple': 'linear-gradient(135deg,#8b5cf6,#6d28d9)',
                'ic-red': 'linear-gradient(135deg,#e74c3c,#c0392b)',
                'ic-teal': 'linear-gradient(135deg,#14b8a6,#0f766e)'
            };
            return {
                icon: card.ic, color: colors[card.icl] || colors['ic-green'],
                tag: card.tag || 'Feature', category: cat.title,
                title: card.title,
                subtitle: card.desc,
                stats: [
                    { val: 'Smart', label: 'Analysis Method' },
                    { val: 'Live', label: 'Data Updates' },
                    { val: 'Yours', label: 'Data Privacy' },
                    { val: '2 min', label: 'Setup Time' }
                ],
                what: card.desc + ' This tool uses your M-Pesa transaction history to give you a personalised view tailored specifically to your spending patterns — not generic advice, but insights built from your own data.',
                how: [
                    { title: 'Load your data', body: 'Your uploaded M-Pesa statement is analysed to find relevant transactions for this tool.' },
                    { title: 'Generate your personalised view', body: 'We apply our models to produce insights specific to your history and patterns.' },
                    { title: 'Review your results', body: 'A clear breakdown shows you exactly what we found and what it means for your finances.' },
                    { title: 'Take action', body: 'Each insight comes with a concrete recommended action you can take immediately.' },
                    { title: 'Track improvement', body: 'Upload next month\'s statement to see how your numbers have changed.' }
                ],
                benefits: [
                    { icon: '📊', title: 'Data-driven', body: 'Every insight is backed by your actual transaction history — no assumptions.' },
                    { icon: '⚡', title: 'Fast results', body: 'Full analysis completes in under 60 seconds from statement upload.' },
                    { icon: '🎯', title: 'Actionable', body: 'Every finding comes with a specific next step you can take today.' },
                    { icon: '🔒', title: 'Private', body: 'Your financial data never leaves your personal account.' }
                ],
                faqs: [
                    { q: 'How often should I use this tool?', a: 'We recommend reviewing this monthly, ideally after uploading each new M-Pesa statement.' },
                    { q: 'Is my data secure?', a: 'Yes — your M-Pesa data is encrypted and only used to generate your personal insights. It is never shared or sold.' },
                    { q: 'What if my situation changes significantly?', a: 'Upload a new statement at any time and all tools will refresh with your latest data.' }
                ],
                savings: [
                    { label: 'Estimated Annual Benefit', pct: 45, val: 'KES 5,000–15,000' },
                    { label: 'Time to First Insight', pct: 100, val: '< 60 seconds' },
                    { label: 'Setup Complexity', pct: 10, val: 'Very Easy' }
                ],
                related: []
            };
        }

        function openDetail(dirType, cardIdx) {
            // Get detail data — use specific if available, else build generic
            let d = null;
            if (detailData[dirType] && detailData[dirType][cardIdx]) {
                d = detailData[dirType][cardIdx];
            } else {
                d = buildGenericDetail(dirType, cardIdx);
            }
            if (!d) return;

            const html = `
        <div class="detail-hero" style="background:${d.color}">
            <div class="detail-hero-top">
                <button class="detail-back-btn" onclick="showScreen('directory')">← Back</button>
                <div class="detail-hero-icon">${d.icon}</div>
                <div class="detail-hero-text">
                    <div class="detail-tag-row">
                        <span class="detail-tag">${d.category}</span>
                        <span class="detail-tag">${d.tag}</span>
                    </div>
                    <h1>${d.title}</h1>
                    <p class="detail-hero-sub">${d.subtitle}</p>
                </div>
            </div>
        </div>

        <div class="detail-stat-row">
            ${d.stats.map(s => `
            <div class="detail-stat">
                <div class="detail-stat-val">${s.val}</div>
                <div class="detail-stat-label">${s.label}</div>
            </div>`).join('')}
        </div>

        <div class="detail-body">
            <div class="detail-main">
                <div class="detail-section">
                    <h2>📋 What Is This?</h2>
                    <p style="color:var(--muted); line-height:1.7; font-size:0.95rem;">${d.what}</p>
                </div>

                <div class="detail-section">
                    <h2>🔢 How It Works — Step by Step</h2>
                    <div class="how-steps">
                        ${d.how.map((s, i) => `
                        <div class="how-step">
                            <div class="how-step-num">${i + 1}</div>
                            <div class="how-step-content">
                                <h4>${s.title}</h4>
                                <p>${s.body}</p>
                            </div>
                        </div>`).join('')}
                    </div>
                </div>

                <div class="detail-section">
                    <h2>✅ Key Benefits</h2>
                    <div class="benefit-list">
                        ${d.benefits.map(b => `
                        <div class="benefit-item">
                            <div class="benefit-icon">${b.icon}</div>
                            <div>
                                <h4>${b.title}</h4>
                                <p>${b.body}</p>
                            </div>
                        </div>`).join('')}
                    </div>
                </div>

                <div class="detail-section">
                    <h2>💰 Savings Breakdown</h2>
                    <p style="color:var(--muted); font-size:0.85rem; margin-bottom:1.25rem;">Estimated annual savings based on your transaction data</p>
                    <div class="savings-bar-wrap">
                        ${d.savings.map((s, i) => `
                        <div class="savings-bar-item">
                            <div class="savings-bar-label">
                                <span>${s.label}</span>
                                <span style="color:var(--green); font-family:'JetBrains Mono',monospace;">${s.val}</span>
                            </div>
                            <div class="savings-bar-track">
                                <div class="savings-bar-fill" style="width:0%" data-pct="${s.pct}"></div>
                            </div>
                        </div>`).join('')}
                    </div>
                </div>

                <div class="detail-section">
                    <h2>❓ Frequently Asked Questions</h2>
                    <div class="faq-list">
                        ${d.faqs.map((f, i) => `
                        <div class="faq-item" onclick="toggleFaq(this)">
                            <div class="faq-q">${f.q} <span class="faq-arrow">▼</span></div>
                            <div class="faq-a">${f.a}</div>
                        </div>`).join('')}
                    </div>
                </div>
            </div>

            <div class="detail-sidebar">
                <div class="sidebar-cta" style="background:${d.color}">
                    <h3>Ready to Get Started?</h3>
                    <p>This tool is already set up and waiting for you — your data is loaded and results are ready.</p>
                    <button class="sidebar-cta-btn" onclick="showToast('✅ ${d.title} activated!')">Activate ${d.title}</button>
                    <button class="sidebar-cta-btn sidebar-cta-secondary" onclick="showScreen('dashboard')">Back to Dashboard</button>
                </div>

                ${d.related && d.related.length ? `
                <div class="sidebar-related">
                    <h3>🔗 Related Tools</h3>
                    ${d.related.map(r => `
                    <div class="related-item" onclick="openDetail('${r.dir}', ${r.idx})">
                        <div class="related-icon ${dirData[r.dir]?.cards[r.idx]?.icl || 'ic-green'}">${r.icon}</div>
                        <div>
                            <div class="related-title">${r.title}</div>
                            <div class="related-desc">${r.desc}</div>
                        </div>
                        <span class="related-arrow">→</span>
                    </div>`).join('')}
                </div>` : ''}
            </div>
        </div>`;

            document.getElementById('detailContent').innerHTML = html;
            showScreen('detail');

            // Animate savings bars after render
            setTimeout(() => {
                document.querySelectorAll('.savings-bar-fill').forEach(bar => {
                    bar.style.width = bar.dataset.pct + '%';
                });
            }, 80);
        }

        function toggleFaq(el) {
            const wasOpen = el.classList.contains('open');
            document.querySelectorAll('.faq-item.open').forEach(f => f.classList.remove('open'));
            if (!wasOpen) el.classList.add('open');
        }

        function showToast(msg) {
            const t = document.createElement('div');
            t.className = 'toast';
            t.textContent = msg.startsWith('✅') ? msg : '✅ ' + msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // ===================================================================
        // CHARTS
        // ===================================================================
        let chartsInited = false;
        function initCharts() {
            if (chartsInited) return;
            chartsInited = true;

            window.catChartRef = new Chart(document.getElementById('catChart'), {
                type: 'pie',
                data: { labels: ["Friends & Family", "Food & Dining", "M-Pesa Fees", "Transport", "Bills", "Savings", "Shopping", "Groceries", "Gov Bills", "Contribution"], datasets: [{ data: [34182, 29075, 21475, 21149, 21031, 11877, 10244, 8178, 4493, 4361], backgroundColor: ['#3b82f6', '#e74c3c', '#f59e0b', '#8b5cf6', '#14b8a6', '#e67e22', '#06b6d4', '#c0392b', '#6366f1', '#27ae60'] }] },
                options: { responsive: true, plugins: { legend: { position: 'right', labels: { font: { size: 10 }, boxWidth: 12 } } } }
            });

            window.trendChartRef = new Chart(document.getElementById('trendChart'), {
                type: 'line',
                data: {
                    labels: ["Sep '25", "Oct '25", "Nov '25", "Dec '25", "Jan '26", "Feb '26"],
                    datasets: [
                        { label: 'Spending', data: [14877, 7400, 5920, 12335, 10085, 2239], borderColor: '#e74c3c', backgroundColor: 'rgba(231,76,60,0.08)', tension: 0.4, fill: true },
                        { label: 'Income', data: [15000, 8000, 10000, 13000, 11000, 5000], borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.05)', tension: 0.4, fill: true }
                    ]
                },
                options: { responsive: true, plugins: { legend: { display: true, position: 'top', labels: { font: { size: 10 } } } }, scales: { y: { beginAtZero: true } } }
            });

            window.essChartRef = new Chart(document.getElementById('essChart'), {
                type: 'bar',
                data: {
                    labels: ['Bills', 'Transport', 'Groceries', 'Shopping', 'Airtime', 'Gov Bills', 'Contribution', 'Subscriptions'],
                    datasets: [{
                        data: [115000, 112000, 104000, 46000, 45000, 32000, 80000, 46000],
                        backgroundColor: ['#27ae60', '#27ae60', '#27ae60', '#27ae60', '#27ae60', '#27ae60', '#e74c3c', '#e74c3c'],
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { beginAtZero: true, title: { display: true, text: 'Amount (KES)', font: { size: 10 } } },
                        y: { ticks: { font: { size: 9 } } }
                    }
                }
            });

            window.savChartRef = new Chart(document.getElementById('savChart'), {
                type: 'bar',
                data: { labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5'], datasets: [{ data: [1024000, 700000, 750000, 450000, 280000], backgroundColor: '#3b82f6', borderRadius: 8 }] },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Total Spend (KES)', font: { size: 10 } } } } }
            });

            window.profileProgressChartRef = new Chart(document.getElementById('profileProgressChart'), {
                type: 'line',
                data: {
                    labels: ["Oct '25", "Nov '25", "Dec '25", "Jan '26", "Feb '26"],
                    datasets: [
                        { label: 'Spending', data: [7400, 5920, 12335, 10085, 2239], borderColor: '#e11d48', backgroundColor: 'rgba(225, 29, 72, 0.05)', tension: 0.4, fill: true },
                        { label: 'Savings', data: [1500, 1200, 3000, 2500, 800], borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.05)', tension: 0.4, fill: true }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top', labels: { font: { size: 10 } } } },
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'KES', font: { size: 10 } } } }
                }
            });

            // Sync charts to whatever period is currently active
            const currentData = periodData[activePeriodKey];
            if (currentData) applyPeriod(currentData);
        }

        // ===================================================================
        // INIT
        // ===================================================================
        window.addEventListener('load', () => {
            // Initializing after load if needed
        });


        // ===================================================================
        // AUTHENTICATION FUNCTIONS
        // ===================================================================

        // ===== FIREBASE AUTH LOGIC =====
        // Load Firebase Config fallback (if firebase-config.js is missing locally)
        if (typeof firebaseConfig === 'undefined') {
            console.warn("firebase-config.js not found. Using local placeholders.");
            window.firebaseConfig = {
                apiKey: "YOUR_API_KEY",
                authDomain: "YOUR_PROJECT.firebaseapp.com",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_PROJECT.appspot.com",
                messagingSenderId: "SENDER_ID",
                appId: "APP_ID"
            };
        }

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const provider = new firebase.auth.GoogleAuthProvider();
        let currentUser = null;

        function signInWithGoogle() {
            const btn = document.querySelector('#loginScreen .btn-primary');
            if (btn) btn.disabled = true;

            auth.signInWithPopup(provider)
                .then((result) => {
                    // onAuthStateChanged will handle the screen switch
                })
                .catch((error) => {
                    console.error("Google Sign In Error:", error);
                    showToast('❌ Error signing in: ' + error.message);
                    if (btn) btn.disabled = false;
                });
        }

        function signOutUser() {
            auth.signOut().then(() => {
                showToast('👋 Logged out successfully');
                // Clear UI state
                currentUser = null;
                document.getElementById('statAnalyzed').textContent = '0';
                document.getElementById('statLastUpload').textContent = 'Never';
                document.getElementById('historyList').innerHTML = '<div style="background: white; border-radius: 12px; padding: 1rem; color: #64748b; text-align: center; border: 1px dashed #cbd5e1;">Please sign in to view history.</div>';
                document.getElementById('profileNameLg').textContent = 'User';
                document.getElementById('profileEmailLg').textContent = 'Signed Out';
                document.getElementById('profileAvatarLg').innerHTML = '';
            });
        }

        async function clearHistory() {
            if (!currentUser || !confirm("Are you sure you want to permanently delete your entire analysis history? This cannot be undone.")) return;

            try {
                const snap = await db.collection('users').doc(currentUser.uid).collection('history').get();
                const batch = db.batch();
                snap.forEach(doc => batch.delete(doc.ref));
                await batch.commit();

                // Reset analysis counter
                await db.collection('users').doc(currentUser.uid).update({
                    analyzedCount: 0,
                    lastUpload: 'Never'
                });

                showToast('🗑️ History cleared');
                document.getElementById('statAnalyzed').textContent = '0';
                document.getElementById('statLastUpload').textContent = 'Never';
                document.getElementById('historyList').innerHTML = '<div style="background: white; border-radius: 12px; padding: 1rem; color: #64748b; text-align: center; border: 1px dashed #cbd5e1;">No past analysis runs found.</div>';
            } catch (err) {
                console.error("Error clearing history:", err);
                showToast('❌ Error clearing history');
            }
        }

        async function resetLearning() {
            if (!currentUser || !confirm("Are you sure you want to reset all learned merchant patterns? The app will need to be retrained on your transactions.")) return;

            try {
                const snap = await db.collection('users').doc(currentUser.uid).collection('merchants').get();
                const batch = db.batch();
                snap.forEach(doc => batch.delete(doc.ref));
                await batch.commit();

                showToast('🧠 Merchant patterns reset');
            } catch (err) {
                console.error("Error resetting learning:", err);
                showToast('❌ Error resetting patterns');
            }
        }

        auth.onAuthStateChanged(user => {
            const userInfoDiv = document.getElementById('userInfo');
            const navLinks = document.getElementById('navLinks');

            if (user) {
                // User is signed in
                currentUser = user;
                // Use email prefix as name if displayName is not available
                const emailPrefix = user.email ? user.email.split('@')[0] : 'User';
                const name = user.displayName || emailPrefix;
                const initial = name.charAt(0).toUpperCase();

                let avatarHtml = `<div class="user-avatar">${initial}</div>`;
                if (user.photoURL) {
                    avatarHtml = `<img src="${user.photoURL}" alt="Profile" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid white;">`;
                }

                userInfoDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.3rem 0.6rem; border-radius: 20px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'" onclick="showScreen('profile')">
                ${avatarHtml}
                <span style="font-weight:700; font-size:0.9rem;">${name}</span>
            </div>
            <button onclick="signOutUser()" class="btn btn-secondary btn-sm" style="margin-left: 10px; padding: 0.3rem 0.6rem;">Sign Out</button>
        `;

                // Populate Profile Screen Data
                const profileAvatarLg = document.getElementById('profileAvatarLg');
                if (user.photoURL) {
                    profileAvatarLg.innerHTML = `<img src="${user.photoURL}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover;">`;
                } else {
                    profileAvatarLg.innerHTML = initial;
                }
                document.getElementById('profileNameLg').textContent = name;
                document.getElementById('profileEmailLg').textContent = user.email || 'No email provided';

                // Initial stats from Firestore
                const userDocRef = db.collection('users').doc(user.uid);
                userDocRef.get().then((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        document.getElementById('statAnalyzed').textContent = data.analyzedCount || 0;
                        document.getElementById('statRules').textContent = data.rulesConfigured || 3;
                        document.getElementById('statLastUpload').textContent = data.lastUpload || 'Never';
                    } else {
                        // Create initial profile in Firestore
                        userDocRef.set({
                            name: name,
                            email: user.email,
                            photoURL: user.photoURL,
                            analyzedCount: 0,
                            rulesConfigured: 3,
                            lastUpload: 'Never',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        document.getElementById('statAnalyzed').textContent = 0;
                        document.getElementById('statRules').textContent = 3;
                        document.getElementById('statLastUpload').textContent = 'Never';
                    }
                }).catch((error) => {
                    console.error("Error getting Firestore document:", error);
                });

                // Fetch past history
                db.collection('users').doc(user.uid).collection('history').orderBy('timestamp', 'desc').get().then(snap => {
                    const historyList = document.getElementById('historyList');
                    if (snap.empty) {
                        historyList.innerHTML = '<div style="background: white; border-radius: 12px; padding: 1rem; color: #64748b; text-align: center; border: 1px dashed #cbd5e1;">No past analysis runs found.</div>';
                    } else {
                        historyList.innerHTML = '';
                        snap.forEach(doc => {
                            const h = doc.data();
                            const date = h.timestamp ? h.timestamp.toDate().toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) : 'Recently';
                            historyList.innerHTML += `
                                <div style="background: white; border-radius: 12px; padding: 1rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #f1f5f9;">
                                    <div>
                                        <div style="font-weight: 700; color: #1e293b;">${date}</div>
                                        <div style="font-size: 0.8rem; color: #64748b;">${h.transactionCount} transactions analyzed</div>
                                    </div>
                                    <div style="text-align: right; display: flex; gap: 1rem;">
                                        <div><div style="font-size: 0.7rem; color: #94a3b8; text-transform: uppercase;">Spent</div><div style="font-weight: 700; color: #e11d48;">${h.totalSpent}</div></div>
                                        <div><div style="font-size: 0.7rem; color: #94a3b8; text-transform: uppercase;">Saved</div><div style="font-weight: 700; color: #10b981;">${h.estimatedSavings}</div></div>
                                    </div>
                                </div>
                            `;
                        });
                    }
                });

                // Prepare merchant learning (Optional: skip merchants already learned)
                db.collection('users').doc(user.uid).collection('merchants').get().then(snap => {
                    const learned = snap.docs.map(doc => doc.id);
                    // Filter or highlight learned merchants if needed
                    console.log("Found " + learned.length + " learned merchants in cloud");
                });

                // Load Smart Rules from Cloud
                db.collection('users').doc(user.uid).collection('rules').doc('categorization').get().then(doc => {
                    if (doc.exists) {
                        const r = doc.data();
                        if (document.getElementById('rule1-freq')) {
                            document.getElementById('rule1-freq').value = r.rule1Freq;
                            document.getElementById('rule1-amount').value = r.rule1Amount;
                            document.getElementById('rule1-cat').value = r.rule1Cat;
                            document.getElementById('rule2-freq').value = r.rule2Freq;
                            document.getElementById('rule2-amount').value = r.rule2Amount;
                            document.getElementById('rule2-cat').value = r.rule2Cat;
                            document.getElementById('rule3-cat').value = r.rule3Cat;
                            updatePreview();
                        }
                    }
                });
                if (navLinks) navLinks.style.display = 'flex';

                // If they were on the login screen, move them to upload
                if (document.getElementById('loginScreen') && document.getElementById('loginScreen').classList.contains('active')) {
                    showScreen('upload');
                    showToast('✅ Welcome back, ' + name + '!');
                }
            } else {
                // No user signed in
                currentUser = null;
                userInfoDiv.innerHTML = `
            <button id="googleSignInBtn" class="btn btn-primary btn-sm" onclick="showScreen('login')">Sign in</button>
        `;
                if (navLinks) navLinks.style.display = 'none';

                // Reset Google sign in button if it's there
                const btn = document.querySelector('#loginScreen .btn-primary');
                if (btn) btn.disabled = false;

                // Show landing screen by default if logged out (unless already on it)
                if (!document.getElementById('landingScreen').classList.contains('active')) {
                    showScreen('landing');
                }
            }
        });

        // ===================================================================
        // HELP CENTER FUNCTIONS
        // ===================================================================

        function searchHelp(query) {
            const sections = document.querySelectorAll('.help-article');
            const q = query.toLowerCase();

            sections.forEach(section => {
                const text = section.textContent.toLowerCase();
                if (q === '' || text.includes(q)) {
                    section.style.display = 'block';
                } else {
                    section.style.display = 'none';
                }
            });
        }

        function scrollToHelp(id) {
            const el = document.getElementById(id);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            return false;
        }

        function showTerms() {
            alert('Terms of Service:\n\n1. You own your data\n2. We never sell your information\n3. You can delete your account anytime\n\nFull terms available at mpesa-analyzer.com/terms');
        }

        function showPrivacy() {
            alert('Privacy Policy:\n\n1. All data encrypted in transit and at rest\n2. Your M-Pesa PIN never leaves your device\n3. No third-party data sharing\n\nFull policy available at mpesa-analyzer.com/privacy');
        }

        function openLiveChat() {
            showToast('💬 Live chat feature coming soon!');
        }

        function openBugReport() {
            showToast('🐛 Bug report form coming soon!');
        }

        function openFeatureRequest() {
            showToast('💡 Feature request form coming soon!');
        }

        // Auth listeners are now self-bootstrapping via onAuthStateChanged



    </script>
</body>

</html>